
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>encodermap.plot.interactive_plotting &#8212; encodermap 3.0.1+10.g67ae638.dirty documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c1026b93" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=ea0ca436"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/encodermap/plot/interactive_plotting';</script>
    <link rel="icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="3.0.1+10.g67ae638.dirty" />
    <meta name="docbuild:last-update" content="2025-05-15T21:24:25"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo_cube_300.png" class="logo__image only-light" alt="encodermap 3.0.1+10.g67ae638.dirty documentation - Home"/>
    <img src="../../../_static/logo_cube_300.png" class="logo__image only-dark pst-js-only" alt="encodermap 3.0.1+10.g67ae638.dirty documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notebooks/index.html">
    Notebook Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Ag-Peter/encodermap" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notebooks/index.html">
    Notebook Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Ag-Peter/encodermap" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../encodermap.html" class="nav-link">encodermap</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">encodermap.plot.interactive_plotting</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for encodermap.plot.interactive_plotting</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># encodermap/plot/interactive_plotting.py</span>
<span class="c1">################################################################################</span>
<span class="c1"># EncoderMap: A python library for dimensionality reduction.</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2019-2024 University of Konstanz and the Authors</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># Kevin Sawade, Tobias Lemke</span>
<span class="c1">#</span>
<span class="c1"># Encodermap is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as</span>
<span class="c1"># published by the Free Software Foundation, either version 2.1</span>
<span class="c1"># of the License, or (at your option) any later version.</span>
<span class="c1"># This package is distributed in the hope that it will be useful to other</span>
<span class="c1"># researches. IT DOES NOT COME WITH ANY WARRANTY WHATSOEVER; without even the</span>
<span class="c1"># implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1"># See the GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># See &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">################################################################################</span>

<span class="c1">################################################################################</span>
<span class="c1"># Imports</span>
<span class="c1">################################################################################</span>


<span class="c1"># Future Imports at the top</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># Standard Library Imports</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Third Party Imports</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">optional_imports</span> <span class="kn">import</span> <span class="n">_optional_import</span>
<span class="kn">from</span> <span class="nn">pip._internal.operations.freeze</span> <span class="kn">import</span> <span class="n">freeze</span>

<span class="c1"># Encodermap imports</span>
<span class="kn">from</span> <span class="nn">encodermap.autoencoder.autoencoder</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">,</span>
    <span class="n">Autoencoder</span><span class="p">,</span>
    <span class="n">DihedralEncoderMap</span><span class="p">,</span>
    <span class="n">EncoderMap</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">encodermap.misc.misc</span> <span class="kn">import</span> <span class="n">_datetime_windows_and_linux_compatible</span><span class="p">,</span> <span class="n">_is_notebook</span>
<span class="kn">from</span> <span class="nn">encodermap.plot.plotting</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_plot_free_energy</span><span class="p">,</span>
    <span class="n">get_histogram</span><span class="p">,</span>
    <span class="n">plot_trajs_by_parameter</span><span class="p">,</span>
    <span class="n">to_density</span><span class="p">,</span>
    <span class="n">to_free_energy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">encodermap.trajinfo.info_all</span> <span class="kn">import</span> <span class="n">TrajEnsemble</span>
<span class="kn">from</span> <span class="nn">encodermap.trajinfo.info_single</span> <span class="kn">import</span> <span class="n">SingleTraj</span>


<span class="c1">################################################################################</span>
<span class="c1"># Optional Imports</span>
<span class="c1">################################################################################</span>


<span class="n">sns</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;seaborn&quot;</span><span class="p">)</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;mdtraj&quot;</span><span class="p">)</span>
<span class="n">jinja2</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;jinja2&quot;</span><span class="p">)</span>
<span class="n">make_subplots</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;subplots.make_subplots&quot;</span><span class="p">)</span>
<span class="n">px</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;express&quot;</span><span class="p">)</span>
<span class="n">go</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;graph_objects&quot;</span><span class="p">)</span>
<span class="n">Image</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;PIL&quot;</span><span class="p">,</span> <span class="s2">&quot;Image&quot;</span><span class="p">)</span>
<span class="n">Canvas</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;ipycanvas&quot;</span><span class="p">,</span> <span class="s2">&quot;Canvas&quot;</span><span class="p">)</span>
<span class="n">hold_canvas</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;ipycanvas&quot;</span><span class="p">,</span> <span class="s2">&quot;hold_canvas&quot;</span><span class="p">)</span>
<span class="n">nv</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;nglview&quot;</span><span class="p">)</span>
<span class="n">psutil</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;psutil&quot;</span><span class="p">)</span>
<span class="n">display</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;IPython&quot;</span><span class="p">,</span> <span class="s2">&quot;display.display&quot;</span><span class="p">)</span>
<span class="n">Image</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;PIL&quot;</span><span class="p">,</span> <span class="s2">&quot;Image&quot;</span><span class="p">)</span>


<span class="c1">################################################################################</span>
<span class="c1"># Typing</span>
<span class="c1">################################################################################</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">from</span> <span class="nn">mdtraj</span> <span class="kn">import</span> <span class="n">Topology</span><span class="p">,</span> <span class="n">Trajectory</span>

    <span class="c1"># Encodermap imports</span>
    <span class="kn">from</span> <span class="nn">encodermap.autoencoder.autoencoder</span> <span class="kn">import</span> <span class="n">AutoencoderClass</span>


<span class="c1">################################################################################</span>
<span class="c1"># Globals</span>
<span class="c1">################################################################################</span>


<span class="n">__all__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;InteractivePlotting&quot;</span><span class="p">]</span>


<span class="c1"># fmt: off</span>
<span class="n">BAD_MODEBAR_BUTTONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;autoScale2d&quot;</span><span class="p">,</span> <span class="s2">&quot;autoscale&quot;</span><span class="p">,</span> <span class="s2">&quot;editInChartStudio&quot;</span><span class="p">,</span> <span class="s2">&quot;editinchartstudio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hoverCompareCartesian&quot;</span><span class="p">,</span> <span class="s2">&quot;hovercompare&quot;</span><span class="p">,</span> <span class="s2">&quot;lasso&quot;</span><span class="p">,</span> <span class="s2">&quot;lasso2d&quot;</span><span class="p">,</span> <span class="s2">&quot;orbitRotation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;orbitrotation&quot;</span><span class="p">,</span> <span class="s2">&quot;pan&quot;</span><span class="p">,</span> <span class="s2">&quot;pan2d&quot;</span><span class="p">,</span> <span class="s2">&quot;pan3d&quot;</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="s2">&quot;resetCameraDefault3d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;resetCameraLastSave3d&quot;</span><span class="p">,</span> <span class="s2">&quot;resetGeo&quot;</span><span class="p">,</span> <span class="s2">&quot;resetSankeyGroup&quot;</span><span class="p">,</span> <span class="s2">&quot;resetScale2d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;resetViewMapbox&quot;</span><span class="p">,</span> <span class="s2">&quot;resetViews&quot;</span><span class="p">,</span> <span class="s2">&quot;resetcameradefault&quot;</span><span class="p">,</span> <span class="s2">&quot;resetcameralastsave&quot;</span><span class="p">,</span>
    <span class="s2">&quot;resetsankeygroup&quot;</span><span class="p">,</span> <span class="s2">&quot;resetscale&quot;</span><span class="p">,</span> <span class="s2">&quot;resetview&quot;</span><span class="p">,</span> <span class="s2">&quot;resetviews&quot;</span><span class="p">,</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
    <span class="s2">&quot;select2d&quot;</span><span class="p">,</span> <span class="s2">&quot;sendDataToCloud&quot;</span><span class="p">,</span> <span class="s2">&quot;senddatatocloud&quot;</span><span class="p">,</span> <span class="s2">&quot;tableRotation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tablerotation&quot;</span><span class="p">,</span> <span class="s2">&quot;toImage&quot;</span><span class="p">,</span> <span class="s2">&quot;toggleHover&quot;</span><span class="p">,</span> <span class="s2">&quot;toggleSpikelines&quot;</span><span class="p">,</span> <span class="s2">&quot;togglehover&quot;</span><span class="p">,</span>
    <span class="s2">&quot;togglespikelines&quot;</span><span class="p">,</span> <span class="s2">&quot;toimage&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom2d&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom3d&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomIn2d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zoomInGeo&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomInMapbox&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomOut2d&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomOutGeo&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomOutMapbox&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zoomin&quot;</span><span class="p">,</span> <span class="s2">&quot;zoomout&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># fmt: on</span>


<span class="n">H5_INFO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">## Loading a HDF5 file (.h5) with EncoderMap</span>

<span class="s2">EncoderMap introduces a way of storing multiple trajectories (a `TrajectorEnsemble`) in a</span>
<span class="s2">single file. These files can be loaded via:</span>

<span class="s2">```python</span>
<span class="s2">import encodermap as em</span>
<span class="s2">trajs = em.TrajEnsemble.from_dataset(&#39;{{ h5_file }}&#39;)</span>
<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">PATH_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2"># README for EncoderMap.InteractivePlotting generate</span>

<span class="s2">You just used EncoderMap&#39;s `InteractivePlotting` and saved protein conformations generated from a path in a low-dimensional representation of a {{ ensemble_type}}. The conformations were generated using a trained neural network autoencoder (EncoderMap&#39;s {{ autoencoder_class }} class) from {{ n_points }} {{ lowd_dim }}-dimensional coordinates. The {{ ensemble_type }} contained {{ n_top }} distinct protein topologies. From these topologies, the {{ chosen_top }} was chosen to build this cluster. Find the topological information in the `.pdb` file in this directory. Look at EncoderMap&#39;s documentation at https://ag-peter.github.io/encodermap/ to learn more about Trajectory Ensembles.</span>

<span class="s2">### The complete Ensemble is also present</span>

<span class="s2">If you want to get more information about the clustering you carried out, you can refer to these files:</span>

<span class="s2">### lowd.csv</span>

<span class="s2">This `.csv` file contains info about the complete ensemble this cluster was selected from. The columns are as follows:</span>

<span class="s2">| traj_num  | The number of the trajectory in the full dataset. This number is 0-based. If only one trajectory is loaded, its `trajectory number` might also be `None`. |</span>
<span class="s2">| --------- | ------------------------------------------------------------ |</span>
<span class="s2">| frame_num | The frame number. The trajectory number and frame number can be used to unmistakably identify frames in a trajectory ensemble. Frame numbers are also 0-based. |</span>
<span class="s2">| traj_file | Contains the trajectory data (file formats such as .xtc, .dcd, .h5). |</span>
<span class="s2">| top_file  | Contains the topology of the file (i.e. atom types, masses, residues) (file formats such as .pdb, .gro, .h5). Some trajectory files (.h5) might also contain the topology. In that case `trajectory file` and `topology` file are identical. |</span>
<span class="s2">| time      | The time of the frame. This can be used for time-based indexing of trajectories. EncoderMap offers the `SingleTraj.tsel[time]` accessor to distinguish it from frame-based indexing via `SingleTraj[frame]`. |</span>
<span class="s2">| x         | The x coordinate of the low-dimensional projection.          |</span>
<span class="s2">| y         | The y-coordinate of the low-dimensional projection.          |</span>

<span class="s2">### path.npy</span>

<span class="s2">This numpy array contains the (x, y)-coordinates of the low-dimensional path, that was used to generate the conformations.</span>

<span class="s2">### path.png</span>

<span class="s2">A nice render of the selected cluster.</span>

<span class="s2">### generated.pdb and generated.xtc</span>

<span class="s2">These files contain the topological (`.pdb`) and trajectory (`.xtc`)information to rebuild this path. Check out the function `encodermap.plot.plottinginteractive_path_visualization`, which can be used to display a animation of that path:</span>

<span class="s2">```python</span>
<span class="s2">import encodermap as em</span>
<span class="s2">import numpy as np</span>
<span class="s2">import pandas as pd</span>

<span class="s2">path = em.load(&quot;{{ xtc_file }}&quot;, &quot;{{ pdb_file }}&quot;)</span>
<span class="s2">lowd = pd.read_csv(&quot;{{ csv_file }}&quot;)</span>
<span class="s2">path = np.load(&quot;{{ npy_file }}&quot;)</span>

<span class="s2">em.plot.interactive_path_visualization(</span>
<span class="s2">	traj,</span>
<span class="s2">	lowd,</span>
<span class="s2">	path,</span>
<span class="s2">)</span>
<span class="s2">```</span>



<span class="s2">## Rendering this document</span>

<span class="s2">If you don&#39;t like to view plain markdown files with a text-viewer there are many viewers available, that are able to render markdown nicely. I am currently using ghostwriter:</span>

<span class="s2">https://ghostwriter.kde.org/</span>

<span class="s2">If you want to create a pdf from this document you can try a combination of pandoc, latex and groff.</span>

<span class="s2">### HTML</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -o {{filename}}.html</span>
<span class="s2">```</span>

<span class="s2">### Latex</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -o {{filename}}.pdf</span>
<span class="s2">```</span>

<span class="s2">### Groff</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -t ms -o {{filename}}.pdf</span>
<span class="s2">```</span>

<span class="s2">## Debug Info</span>

<span class="s2">```</span>
<span class="s2">encodermap.__version__ = {{encodermap_version}}</span>
<span class="s2">system_user = {{system_user}}</span>
<span class="s2">platform = {{platform}}</span>
<span class="s2">platform_release = {{platform_release}}</span>
<span class="s2">platform_version = {{platform_version}}</span>
<span class="s2">architecture = {{architecture}}</span>
<span class="s2">hostname = {{hostname}}</span>
<span class="s2">ip_address = {{ip_address}}</span>
<span class="s2">mac_address = {{mac_address}}</span>
<span class="s2">processor = {{processor}}</span>
<span class="s2">ram = {{ram}}</span>
<span class="s2">pip freeze = {{pip_freeze}}</span>
<span class="s2">```</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="n">CLUSTER_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2"># README for EncoderMap.InteractivePlotting cluster</span>

<span class="s2">You just used EncoderMap&#39;s `InteractivePlotting` and saved a cluster. Here&#39;s some information about this cluster. The cluster was selected from a `TrajectoryEnsemble` containing {{ n_trajs }} trajectories, {{ n_frames }} frames and {{ n_top }} unique topologies. This cluster was assigned the number {{ cluster_num }}. The file {{ h5_file }} contains only {{ n_points }} frames, chosen as representatives for this cluster. This file can be loaded with EncoderMap&#39;s `TrajEnsemble.from_dataset(&#39;{{ h5_file }}&#39;)` method. Look at EncoderMap&#39;s documentation at https://ag-peter.github.io/encodermap/ to learn more about Trajectory Ensembles.</span>

<span class="s2">### The complete Ensemble is also present</span>

<span class="s2">If you want to get more information about the clustering you carried out, you can refer to these files:</span>

<span class="s2">### cluster_{{ cluster_num }}.csv</span>

<span class="s2">This `.csv` file contains info about the complete ensemble this cluster was selected from. The columns are as follows:</span>

<span class="s2">| traj_num   | The number of the trajectory in the full dataset. This number is 0-based. If only one trajectory is loaded, its `trajectory number` might also be `None`. |</span>
<span class="s2">| ---------- | ------------------------------------------------------------ |</span>
<span class="s2">| frame_num  | The frame number. The trajectory number and frame number can be used to unmistakably identify frames in a trajectory ensemble. Frame numbers are also 0-based. |</span>
<span class="s2">| traj_file  | Contains the trajectory data (file formats such as .xtc, .dcd, .h5). |</span>
<span class="s2">| top_file   | Contains the topology of the file (i.e. atom types, masses, residues) (file formats such as .pdb, .gro, .h5). Some trajectory files (.h5) might also contain the topology. In that case `trajectory file` and `topology` file are identical. |</span>
<span class="s2">| time       | The time of the frame. This can be used for time-based indexing of trajectories. EncoderMap offers the `SingleTraj.tsel[time]` accessor to distinguish it from frame-based indexing via `SingleTraj[frame]`. |</span>
<span class="s2">| x          | The x coordinate of the low-dimensional projection.          |</span>
<span class="s2">| y          | The y-coordinate of the low-dimensional projection.          |</span>
<span class="s2">| cluster_id | This column contains -1, which are points not included in a cluster (outliers). Cluster 1 is denoted by a 0 in this column. If multiple clusters have been selected this column can contain multiple integer values. For every subsequent cluster, the `cluster_id` is advanced by 1. |</span>

<span class="s2">### cluster_{{ cluster_num }}_selector.npy</span>

<span class="s2">This numpy array contains the (x, y)-coordinates of the selector, that was used to highlight the cluster. Be careful, this shape might not be convex, so using convex algortihms to find points inside this Polygon might not work.</span>

<span class="s2">### cluster_{{ cluster_num }}.png</span>

<span class="s2">A nice render of the selected cluster.</span>

<span class="s2">{{ h5_info }}</span>

<span class="s2">## Rendering this document</span>

<span class="s2">If you don&#39;t like to view plain markdown files with a text-viewer there are many viewers available, that are able to render markdown nicely. I am currently using ghostwriter:</span>

<span class="s2">https://ghostwriter.kde.org/</span>

<span class="s2">If you want to create a pdf from this document you can try a combination of pandoc, latex and groff.</span>

<span class="s2">### HTML</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -o {{filename}}.html</span>
<span class="s2">```</span>

<span class="s2">### Latex</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -o {{filename}}.pdf</span>
<span class="s2">```</span>

<span class="s2">### Groff</span>

<span class="s2">```bash</span>
<span class="s2">pandoc {{filename}}.md -t ms -o {{filename}}.pdf</span>
<span class="s2">```</span>

<span class="s2">## Debug Info</span>

<span class="s2">```</span>
<span class="s2">encodermap.__version__ = {{encodermap_version}}</span>
<span class="s2">system_user = {{system_user}}</span>
<span class="s2">platform = {{platform}}</span>
<span class="s2">platform_release = {{platform_release}}</span>
<span class="s2">platform_version = {{platform_version}}</span>
<span class="s2">architecture = {{architecture}}</span>
<span class="s2">hostname = {{hostname}}</span>
<span class="s2">ip_address = {{ip_address}}</span>
<span class="s2">mac_address = {{mac_address}}</span>
<span class="s2">processor = {{processor}}</span>
<span class="s2">ram = {{ram}}</span>
<span class="s2">pip freeze = {{pip_freeze}}</span>

<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1">################################################################################</span>
<span class="c1"># Utils</span>
<span class="c1">################################################################################</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">set_env</span><span class="p">(</span><span class="o">**</span><span class="n">environ</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Temporarily set the process environment variables.</span>

<span class="sd">    &gt;&gt;&gt; with set_env(PLUGINS_DIR=&#39;test/plugins&#39;):</span>
<span class="sd">    ...   &quot;PLUGINS_DIR&quot; in os.environ</span>
<span class="sd">    True</span>

<span class="sd">    &gt;&gt;&gt; &quot;PLUGINS_DIR&quot; in os.environ</span>
<span class="sd">    False</span>

<span class="sd">    :type environ: dict[str, unicode]</span>
<span class="sd">    :param environ: Environment variables to set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_environ</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_all_templates_defined</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">):</span>
    <span class="c1"># Standard Library Imports</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\{(.*?)\}&quot;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="n">min_matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">matchNum</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">groupNum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())):</span>
            <span class="n">min_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">groupNum</span><span class="p">))</span>
    <span class="n">min_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;}}&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">min_matches</span><span class="p">]))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">info_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">min_matches</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">min_matches</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Not all expressions defined in template. Missing expressions: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">render_image</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">nv</span><span class="o">.</span><span class="n">NGLWidget</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders a nv.NGLWidget inside a thread.</span>

<span class="sd">    Args:</span>
<span class="sd">        view (nv.NGLWidget): The widget to be rendered.</span>
<span class="sd">        filename (str): The file to render to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">view</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">render_image</span><span class="p">()</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">im</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">plotly_freeform_to_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="n">verts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">])</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">distance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">fx</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">fy</span><span class="p">(</span><span class="n">alpha</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="c1">################################################################################</span>
<span class="c1"># Interactive Plotting</span>
<span class="c1">################################################################################</span>


<span class="k">class</span> <span class="nc">ProgressWidgetTqdmCompatible</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A jupyter widgtes `IntProgress` wrapper, that is compatible with tqdm calls.</span>

<span class="sd">    Uses a contextmanager to open and close the progress bar.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">widgets</span><span class="o">.</span><span class="n">GridspecLayout</span><span class="p">,</span>
        <span class="n">empty</span><span class="p">:</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">,</span>
        <span class="n">total</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate the progress bar.</span>

<span class="sd">        Args:</span>
<span class="sd">            container (widgets.GridSpecLayout): An instance of a widgets.GridSpecLayouts</span>
<span class="sd">                class. The progress bar will be placed in row 7 (index 6) at columns</span>
<span class="sd">                2 through to the end (index 1:).</span>
<span class="sd">            empty (widgtes.Output): After the progress bar closes, this object</span>
<span class="sd">                will be placed at the position of the progress bar to clear it.</span>
<span class="sd">            total (int): The initial total to count to.</span>
<span class="sd">            description (str): The description of the progress bar.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ENCODERMAP_PRINT_PROG_UPDATES&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntProgress</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;90%&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span>

    <span class="k">def</span> <span class="nf">debug_print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints debug info.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WidgetProgbar </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">function</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> total: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}</span><span class="s2"> n: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;update_calls&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advances the progress bar by n.</span>

<span class="sd">        Args:</span>
<span class="sd">            n (int): How far to advance. Defaults to 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">function</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;update_calls&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function</span><span class="p">][</span><span class="s2">&quot;update_calls&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the progress bar with a new total.</span>

<span class="sd">        Args:</span>
<span class="sd">            total (int): New total. It should be greater than old total.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">function</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;update_calls&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntProgress</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="s2">&quot;90%&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span>


<div class="viewcode-block" id="InteractivePlotting">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting">[docs]</a>
<span class="k">class</span> <span class="nc">InteractivePlotting</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;EncoderMap&#39;s interactive plotting for jupyter notebooks.</span>

<span class="sd">    Instantiating this class will display an interactive display in your notebook.</span>
<span class="sd">    The display will look like this::</span>

<span class="sd">         </span>
<span class="sd">        Display               Top        </span>
<span class="sd">         </span>
<span class="sd">          </span>
<span class="sd">                                       </span>
<span class="sd">                       T               </span>
<span class="sd">          Main         R    Molecular  </span>
<span class="sd">          Plotting     A    Conform.   </span>
<span class="sd">          Area         C    Area       </span>
<span class="sd">                       E               </span>
<span class="sd">                                       </span>
<span class="sd">          </span>
<span class="sd">         </span>
<span class="sd">            Progress Bar                 </span>
<span class="sd">         </span>
<span class="sd">            </span>
<span class="sd">        C G S D Slider             </span>
<span class="sd">            </span>
<span class="sd">          </span>
<span class="sd">                                         </span>
<span class="sd">         Data                            </span>
<span class="sd">         Overview                        </span>
<span class="sd">                                         </span>
<span class="sd">                                         </span>
<span class="sd">          </span>

<span class="sd">    The components do the following:</span>
<span class="sd">        * Display:</span>
<span class="sd">            This part will display debug information.</span>
<span class="sd">        * Top (Top selector):</span>
<span class="sd">            Select which topology to use when creating new</span>
<span class="sd">            molecular conformations from the autoencoder network.</span>
<span class="sd">        * Main plotting area:</span>
<span class="sd">            In this area, a scatter plot will be displayed. The coordinates of</span>
<span class="sd">            the scatter plot will be taken from the low-dimensional projection</span>
<span class="sd">            of the trajectories. The data for this plotting area can be</span>
<span class="sd">            taken from different sources. See the `_lowd_parser` docstring</span>
<span class="sd">            for information on how the lowd data is selected. Clicking</span>
<span class="sd">            on a point in the scatter plot displays the conformation of that</span>
<span class="sd">            point.</span>
<span class="sd">        * TRACE:</span>
<span class="sd">            Displays the high-dimensinal data of selected points or clusters.</span>
<span class="sd">        * Molecular conformation area:</span>
<span class="sd">            Displays molecular conformations.</span>
<span class="sd">        * Progress Bar:</span>
<span class="sd">            Displays progress.</span>
<span class="sd">        * C (Cluster button):</span>
<span class="sd">            After selecting point in the main plotting area</span>
<span class="sd">            with the lasso tool, hit this button to display the molecular</span>
<span class="sd">            conformations of the selected cluster.</span>
<span class="sd">        * G (Generate Button):</span>
<span class="sd">            Switch to density using the density button.</span>
<span class="sd">            Then, you can draw a freeform path into the Main plotting area.</span>
<span class="sd">            Pressing the generate button will generate the appropriate molecular</span>
<span class="sd">            conformations. If your data has multiple conformations, you can choose</span>
<span class="sd">            which conformation to use for decoding with the top selector.</span>
<span class="sd">        * S (Save button):</span>
<span class="sd">            Writes either a cluster or generated path to your disk. Uses the</span>
<span class="sd">            main_path of the autoencoder (the same directory as the training</span>
<span class="sd">            data will be stored).</span>
<span class="sd">        * D (Density button):</span>
<span class="sd">            Switch the main plotting area to Density.</span>
<span class="sd">        * Slider:</span>
<span class="sd">            In scatter mode this slider defines how many structures to select</span>
<span class="sd">            from a cluster for representation in the molecular conformations</span>
<span class="sd">            window. In density mode, this slider defines how many points along</span>
<span class="sd">            the user-drawn path should be sampled.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_max_filepath_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">_max_slider_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">_cluster_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_user_selected_points&quot;</span>
    <span class="n">_nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">_cluster_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;join&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;join&quot;</span>
    <span class="n">_help_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/AG-Peter/encodermap&quot;</span>

<div class="viewcode-block" id="InteractivePlotting.from_project">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.from_project">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_project</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;linear_dimers&quot;</span><span class="p">]):</span>
        <span class="c1"># Encodermap imports</span>
        <span class="kn">from</span> <span class="nn">encodermap</span> <span class="kn">import</span> <span class="n">load_project</span>

        <span class="n">trajs</span><span class="p">,</span> <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">load_project</span><span class="p">(</span>
            <span class="n">project_name</span><span class="p">,</span>
            <span class="n">traj</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">load_autoencoder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">=</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">trajs</span><span class="o">=</span><span class="n">trajs</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">autoencoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AutoencoderClass</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trajs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">TrajEnsemble</span><span class="p">,</span> <span class="n">SingleTraj</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lowd_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">highd_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">align_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;name CA&quot;</span><span class="p">,</span>
        <span class="n">top</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Topology</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ball_and_stick</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">histogram_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;free_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;density&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">,</span>
        <span class="n">superpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ref_align_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;name CA&quot;</span><span class="p">,</span>
        <span class="n">base_traj</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trajectory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate the InteractivePlotting class.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is recommended to assign an instance of this class to a variable</span>
<span class="sd">            to safe variables from garbage collection::</span>

<span class="sd">                sess = em.InteractivePlotting()</span>

<span class="sd">        Args:</span>
<span class="sd">            autoencoder (Optional[AutoencoderClass]): An instance of any of</span>
<span class="sd">                EncoderMap&#39;s autoencoder classes (`Autoencoder`, `EncoderMap`,</span>
<span class="sd">                `DihedralEncoderMap`, `AngleDihedralCartesianEncoderMap`).</span>
<span class="sd">            trajs (Optional[Union[str, list[str], TrajEnsemble, SingleTraj]]): The</span>
<span class="sd">                trajectory data to use this session. Molecular conformations are</span>
<span class="sd">                selected from these trajectories. Can be one of EncoderMap&#39;s</span>
<span class="sd">                trajectory data containers (`SingleTraj`, `TrajEnsemble`). Can</span>
<span class="sd">                also be a str or a list of str, that point to trajectory files</span>
<span class="sd">                (.xtc, .dcd, .h5, .pdb, .gro). Can also be None. In this case</span>
<span class="sd">                the `autoencoder` argument is expected to be a</span>
<span class="sd">                `AngleDihedralCartesianEncoderMap`, that is expected to contain</span>
<span class="sd">                the trajs. Defaults to None.</span>
<span class="sd">            lowd_data (Optional[np.ndarray]): The low-dimensional data to use</span>
<span class="sd">                for this session. If not provided low-dimensional data will be</span>
<span class="sd">                inferred from either `trajs` or `autoencoder`. Defaults to None.</span>
<span class="sd">            highd_data (Optional[np.ndarray]): The high-dimensional data to use</span>
<span class="sd">                for this session. If not provided high-dimensional data will be</span>
<span class="sd">                inferred from either `trajs` or `autoencoder`. Defaults to None.</span>
<span class="sd">            align_string (str): The alignment string to superimpose the</span>
<span class="sd">                structures of selected clusters. See</span>
<span class="sd">                https://mdtraj.org/1.9.4/atom_selection.html for info on how</span>
<span class="sd">                this string affects the selected atoms. Defaults to &#39;name CA&#39;.</span>
<span class="sd">            top (Optional[Union[str, list[str], Topology]]): If trajs is a str,</span>
<span class="sd">                and a trajectory file format that does not have topological</span>
<span class="sd">                information (.xtc, .dcd), this argument will be used for topology.</span>
<span class="sd">                Can be a str (file) or an instance of MDTraj&#39;s Topology. Can also</span>
<span class="sd">                be a list of str, that matches the list of str in `trajs` with</span>
<span class="sd">                the appropriate topology files. If None is provided, the trajs</span>
<span class="sd">                argument is expected to be either `SingleTraj` or `TrajEnsemble`.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            ball_and_stick (bool): Whether to represent the structures in ball and</span>
<span class="sd">                stick representation (True) or in cartoon representation (False).</span>
<span class="sd">                Defaults to False and cartoon representation.</span>
<span class="sd">            histogram_type (Union[None, Literal[&quot;free_energy&quot;, &quot;density&quot;]]): Decide</span>
<span class="sd">                how to style your histogram. If None, a straight histogram (count</span>
<span class="sd">                per bin) will be plotted. If &#39;density&#39; a density will be plotted.</span>
<span class="sd">                If &#39;free_energy&#39;, the negative natural logartihm of the density</span>
<span class="sd">                will be plotted. Defaults to &#39;free_energy&#39;.</span>
<span class="sd">            superpose (bool): Whether to superpose the clustered structures.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            ref_align_string (str): If a `base_traj` is provided, this string will</span>
<span class="sd">                be used to select the atoms to align the clustering results against.</span>
<span class="sd">            base_traj (Optional[Trajectory]): If not None, this traj will be</span>
<span class="sd">                used to align the clustered frames against. Can be used to make</span>
<span class="sd">                all clusterings be consistent in their placement in the 3d space.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_string</span> <span class="o">=</span> <span class="n">align_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball_and_stick</span> <span class="o">=</span> <span class="n">ball_and_stick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogram_type</span> <span class="o">=</span> <span class="n">histogram_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">superpose</span> <span class="o">=</span> <span class="n">superpose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_align_string</span> <span class="o">=</span> <span class="n">ref_align_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_traj</span> <span class="o">=</span> <span class="n">base_traj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span>

        <span class="c1"># set the layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;modebar_add&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;drawline&quot;</span><span class="p">,</span> <span class="s2">&quot;drawopenpath&quot;</span><span class="p">,</span> <span class="s2">&quot;eraseshape&quot;</span><span class="p">],</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;shapedefaults&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;editable&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># apply nest_asyncio for saving images</span>
        <span class="k">if</span> <span class="n">_is_notebook</span><span class="p">():</span>
            <span class="c1"># Third Party Imports</span>
            <span class="kn">import</span> <span class="nn">nest_asyncio</span>

            <span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>

        <span class="c1"># parse the complex arrangement of args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span> <span class="o">=</span> <span class="n">autoencoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">main_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajs_parser</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">trajs</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highd_parser</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">highd_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lowd_parser</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">lowd_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">traj_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span><span class="p">)</span>

        <span class="c1"># put the data into self.trajs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;highd&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">_CVs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">load_CVs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highd</span><span class="p">,</span> <span class="s2">&quot;highd&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;lowd&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">_CVs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">load_CVs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">,</span> <span class="s2">&quot;lowd&quot;</span><span class="p">)</span>

        <span class="c1"># debugging stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_main_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_main_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_filepath_len</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_main_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
            <span class="p">)</span>

        <span class="c1"># set up base images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_histogram</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_graph</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fake_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">with</span> <span class="n">ProgressWidgetTqdmCompatible</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Testing...&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcenters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ycenters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xedges</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yedges</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">get_histogram</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nbins</span><span class="p">,</span>
            <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">return_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">to_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">to_free_energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_trajs_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">autoencoder</span><span class="p">:</span> <span class="n">AutoencoderClass</span><span class="p">,</span>
        <span class="n">trajs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TrajEnsemble</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">top</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Topology</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrajEnsemble</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses the input trajs and chooses what trajs to use.</span>

<span class="sd">        The order of priority follows:</span>
<span class="sd">            1. The input `trajs` parameter supersedes everything. If `trajs`</span>
<span class="sd">                1.1. If an `AutoencoderClass` has been provided, the trajs are</span>
<span class="sd">                    checked, whether they conform to the expected input shape.</span>
<span class="sd">                2.2. If trajs is a str, rather than a `TrajEnsemble`, the argument</span>
<span class="sd">                    `top` is used to build a `TrajEnsemble` from this topology</span>
<span class="sd">                    and the `trajs`. Thus, `top` can be either str or md.Topology.</span>
<span class="sd">            2. If trajs is None, the `top` argument is not used and the</span>
<span class="sd">                `TrajEnsemble` of the provided `AngleDihedralCartesianEncoderMap`</span>
<span class="sd">                is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            autoencoder (AutoencoderClass): The autoencoder.</span>
<span class="sd">            trajs (Optional[Union[str, TrajEnsemble]]): The trajs.</span>
<span class="sd">            top (Optional[Union[str, Topology]]): The topology.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TrajEnsemble: The trajectory ensemble to use in this session.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="c1"># Standard Library Imports</span>
                <span class="kn">import</span> <span class="nn">errno</span>

                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">),</span> <span class="n">trajs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="c1"># Standard Library Imports</span>
                    <span class="kn">import</span> <span class="nn">errno</span>

                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                        <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">),</span> <span class="n">top</span>
                    <span class="p">)</span>
            <span class="n">trajs</span> <span class="o">=</span> <span class="n">TrajEnsemble</span><span class="p">([</span><span class="n">trajs</span><span class="p">],</span> <span class="p">[</span><span class="n">top</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">trajs</span> <span class="o">=</span> <span class="n">TrajEnsemble</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trajs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">trajs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">inp_CV_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The shape of the CV `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` of the provided `trajs` &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2"> does not match the shape of &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;the train data of the provided `autoencoder` </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">SingleTraj</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">_gen_ensemble</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">trajs</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Please provide a `TrajEnsemble` for the argument `trajs`.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">SingleTraj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">_gen_ensemble</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">trajs</span>

    <span class="k">def</span> <span class="nf">_highd_parser</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">autoencoder</span><span class="p">:</span> <span class="n">AutoencoderClass</span><span class="p">,</span>
        <span class="n">highd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trajs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TrajEnsemble</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Selects which source of high-dimensional data to use.</span>

<span class="sd">        The order of priority follows:</span>
<span class="sd">            1. The provided `highd` np.ndarray.</span>
<span class="sd">                1.1 If an autoencoder has been provided, the high-dimensional</span>
<span class="sd">                    input data will be checked with the autoencoder&#39;s input shape.</span>
<span class="sd">            2. If no high-dimensional data has been provided (`highd=None`), the</span>
<span class="sd">                high-dimensional data from the provided `trajs` will be used.</span>
<span class="sd">            3. If the autoencoder is a `AngleDihedralCartesianEncoderMap`, the</span>
<span class="sd">                trajs of this autoencoder will be used.</span>
<span class="sd">            4. As a last resort, the autoencoder&#39;s `train_data` attribute will</span>
<span class="sd">                be used if the other datasources are not provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            autoencoder (AutoencoderClass): The autoencoder.</span>
<span class="sd">            highd (Optional[np.ndarray]): The high dimensional data.</span>
<span class="sd">            trajs (Optional[Union[str, TrajEnsemble]]): The trajs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The high-dimensional data to use in this session.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;AngleDihedralCartesianEncoderMap&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">highd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The argument `highd_data` only supports None or np.ndarray. You &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;supplied </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">highd</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Confirming the shape of input highd and the input shape &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of the autoencoder model is currently not implemented.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;central_dihedrals&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">_CVs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;The provided `trajs`, don&#39;t have any CVs loaded. I will &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;try to use the input data of the provided autoencoder.&quot;</span>
                        <span class="p">)</span>
                    <span class="n">sparse</span><span class="p">,</span> <span class="n">highd_data</span><span class="p">,</span> <span class="n">CV_dict</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">get_train_data_from_trajs</span><span class="p">(</span>
                        <span class="n">trajs</span><span class="p">,</span>
                        <span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
                        <span class="n">highd_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trajs</span><span class="o">.</span><span class="n">central_dihedrals</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">use_backbone_angles</span><span class="p">:</span>
                            <span class="n">highd_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trajs</span><span class="o">.</span><span class="n">central_angles</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">use_sidechains</span><span class="p">:</span>
                            <span class="n">highd_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">side_dihedrals</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">highd_data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">highd_data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">autoencoder</span><span class="p">,</span> <span class="p">(</span><span class="n">Autoencoder</span><span class="p">,</span> <span class="n">EncoderMap</span><span class="p">,</span> <span class="n">DihedralEncoderMap</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Autoencoder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EncoderMap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DihedralEncoderMap&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">highd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The argument `highd_data` only supports None or np.ndarray. You &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;supplied </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">highd</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Bad `train_data` shape: </span><span class="si">{</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span><span class="si">=}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="si">=}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">assert</span> <span class="n">highd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">_using_hypercube</span><span class="p">,</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The provided np.array in argument `highd_data` has shape </span><span class="si">{</span><span class="n">highd</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but the autoencoder&#39;s `train_data` has shape </span><span class="si">{</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">highd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;highd&quot;</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">highd</span>
                <span class="k">return</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">train_data</span>
        <span class="k">elif</span> <span class="n">autoencoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;highd&quot;</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">highd</span>
            <span class="k">assert</span> <span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Please provide a numpy array containing high-dimensional data &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or load high-dimensional data into your trajs with `trajs.load_CVs`.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">highd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown type for autoencoder: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lowd_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autoencoder</span><span class="p">,</span> <span class="n">lowd</span><span class="p">,</span> <span class="n">trajs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;AngleDihedralCartesianEncoderMap&quot;</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">lowd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lowd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The argument `lowd_data` only supports None or np.ndarray. You &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;supplied </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lowd</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">lowd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;lowd&quot;</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span>
                <span class="k">return</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">autoencoder</span><span class="p">,</span> <span class="p">(</span><span class="n">Autoencoder</span><span class="p">,</span> <span class="n">EncoderMap</span><span class="p">,</span> <span class="n">DihedralEncoderMap</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Autoencoder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EncoderMap&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DihedralEncoderMap&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">lowd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lowd</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The argument `lowd_data` only supports None or np.ndarray. You &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;supplied </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lowd</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">lowd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trajs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;lowd&quot;</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span>
                <span class="k">return</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highd</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">autoencoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;lowd&quot;</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span>
            <span class="k">assert</span> <span class="n">lowd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Please provide a numpy array containing low-dimensional data &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or load low-dimensional data into your trajs with `trajs.load_CVs`.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">lowd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown type for autoencoder: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram_type</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram_type</span> <span class="o">==</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">:</span>
                <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Argument `histogram_type` needs to be either of None, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;density&#39; or &#39;free_energy&#39;. You supplied </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">histogram_type</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Contour</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xcenters</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ycenters</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">H</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;go.Scattergl: The scatter plot using the low-dimensional data.&quot;&quot;&quot;</span>
        <span class="c1"># Third Party Imports</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;trajs&quot;</span><span class="p">):</span>
            <span class="n">basenames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">traj</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">traj_nums</span><span class="p">,</span> <span class="n">frame_nums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">T</span>
            <span class="n">customdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">basenames</span><span class="p">,</span>
                    <span class="n">traj_nums</span><span class="p">,</span>
                    <span class="n">frame_nums</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;%</span><span class="si">{customdata[0]}</span><span class="s2"> (Traj %</span><span class="si">{customdata[1]}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;Frame %</span><span class="si">{customdata[2]}</span><span class="s2">): (%</span><span class="si">{x:.2f}</span><span class="s2">, %</span><span class="si">{y:.2f}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">customdata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># map the values to the same range</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">values_ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values_ma</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values_ma</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># fill an array with the default color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marker_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">),),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># set the marker colors into the marker_colors array</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x_ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">y_ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">yedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
                <span class="n">point_ind</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">x_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">H_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">H_value</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">marker_colors</span><span class="p">[</span><span class="n">point_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_value</span>

        <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_colors</span><span class="p">,</span>
                <span class="s2">&quot;colorscale&quot;</span><span class="p">:</span> <span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="c1"># opacity=0.8,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">customdata</span><span class="o">=</span><span class="n">customdata</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="InteractivePlotting.generate">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.generate">[docs]</a>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="c1"># clear the display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span> <span class="o">=</span> <span class="s2">&quot;Backmapping: &quot;</span>

        <span class="c1"># some error</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First Draw a line onto the Density map and the hit &#39;Generate&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># clear the pandas area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># instantiate the progbar</span>
        <span class="c1"># display a message</span>
        <span class="n">n_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> points. Please stand by.&quot;</span><span class="p">)</span>

        <span class="c1"># set up progbar</span>
        <span class="k">with</span> <span class="n">ProgressWidgetTqdmCompatible</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">:</span>

            <span class="c1"># get the path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_canvas_path_in_data_coords</span><span class="p">()</span>

            <span class="c1"># generate</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="o">==</span> <span class="s2">&quot;AngleDihedralCartesianEncoderMap&quot;</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top_selector</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">progbar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Encodermap imports</span>
                <span class="kn">from</span> <span class="nn">encodermap.misc.backmapping</span> <span class="kn">import</span> <span class="n">mdtraj_backmapping</span>

                <span class="n">dihedrals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span> <span class="o">=</span> <span class="n">mdtraj_backmapping</span><span class="p">(</span>
                    <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top_file</span><span class="p">,</span>
                    <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="p">,</span>
                    <span class="n">progbar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">,</span>
                    <span class="n">omega</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conformations generated.&quot;</span><span class="p">)</span>

        <span class="c1"># clear progbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># create the media widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Play</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">()</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">jslink</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">media_widget</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">media_slider</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">media_widget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">media_slider</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;align-content&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># create the view</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_and_stick</span><span class="p">:</span>
            <span class="n">view</span><span class="o">.</span><span class="n">clear_representations</span><span class="p">()</span>
            <span class="n">view</span><span class="o">.</span><span class="n">add_representation</span><span class="p">(</span><span class="s2">&quot;ball+stick&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>

        <span class="c1"># switch to plotly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># make the slider responsive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">media_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advance_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="InteractivePlotting.advance_path">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.advance_path">[docs]</a>
    <span class="k">def</span> <span class="nf">advance_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></div>


<div class="viewcode-block" id="InteractivePlotting.cluster">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.cluster">[docs]</a>
    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="c1"># clear the display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span> <span class="o">=</span> <span class="s2">&quot;Clustering: &quot;</span>

        <span class="c1"># some error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;First select some points using the Lasso or Polygon tool &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and then click &#39;cluster&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># clear the pandas area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># instantiate the progbar</span>
        <span class="k">with</span> <span class="n">ProgressWidgetTqdmCompatible</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">:</span>
            <span class="c1"># read the slider</span>
            <span class="n">n_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># display a message</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clustering </span><span class="si">{</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> points. Please stand by.&quot;</span><span class="p">)</span>

            <span class="c1"># clustering</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">load_CVs</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">]</span>
                <span class="n">max_</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">load_CVs</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span>
                <span class="n">cluster_id</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">_</span><span class="p">),</span>
                <span class="n">col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">,</span>
                <span class="n">n_points</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_method</span> <span class="o">==</span> <span class="s2">&quot;join&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">align_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_string</span><span class="p">,</span>
                    <span class="n">superpose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">superpose</span><span class="p">,</span>
                    <span class="n">ref_align_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_align_string</span><span class="p">,</span>
                    <span class="n">base_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_traj</span><span class="p">,</span>
                    <span class="n">progbar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># nglview</span>
                <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">center_coordinates</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">view</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">view</span><span class="o">.</span><span class="n">add_trajectory</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_and_stick</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">clear_representations</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total</span><span class="p">):</span>
                        <span class="n">view</span><span class="o">.</span><span class="n">add_representation</span><span class="p">(</span><span class="s2">&quot;ball+stick&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                    <span class="n">align_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_string</span><span class="p">,</span>
                    <span class="n">superpose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">superpose</span><span class="p">,</span>
                    <span class="n">ref_align_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_align_string</span><span class="p">,</span>
                    <span class="n">base_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_traj</span><span class="p">,</span>
                    <span class="n">progbar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># nglview</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="o">.</span><span class="n">center_coordinates</span><span class="p">()</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_and_stick</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">clear_representations</span><span class="p">()</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">add_representation</span><span class="p">(</span><span class="s2">&quot;ball+stick&quot;</span><span class="p">)</span>

            <span class="c1"># trace</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">]</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">_</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># save the image, because threading is complicated in IPython</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp.png&quot;</span><span class="p">)</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">render_image</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># clear progbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># clear display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished clustering.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>

        <span class="c1"># pandas</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span><span class="o">.</span><span class="n">dash_summary</span><span class="p">())</span></div>


<div class="viewcode-block" id="InteractivePlotting.save">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Please select a cluster or a path and hit &#39;Generate&#39; or &quot;</span>
                    <span class="s2">&quot;&#39;Cluster&#39;, before &#39;Save&#39;.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># path save</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Third Party Imports</span>
                    <span class="kn">import</span> <span class="nn">imageio</span>
                    <span class="kn">import</span> <span class="nn">moviepy</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please install moviepy, imageio and ffmpeg&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">with</span> <span class="n">ProgressWidgetTqdmCompatible</span><span class="p">(</span>
                    <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
                    <span class="n">empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Saving..&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_path_on_disk</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path saved at </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fname</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># cluster save</span>
                <span class="k">with</span> <span class="n">ProgressWidgetTqdmCompatible</span><span class="p">(</span>
                    <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
                    <span class="n">empty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Saving...&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_cluster_on_disk</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster saved at </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fname</span></div>


    <span class="k">def</span> <span class="nf">_save_path_on_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="c1"># Third Party Imports</span>
        <span class="kn">from</span> <span class="nn">nglview.contrib.movie</span> <span class="kn">import</span> <span class="n">MovieMaker</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">_datetime_windows_and_linux_compatible</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;generated_paths/</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">output</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># define some files</span>
        <span class="c1"># fmt: off</span>
        <span class="n">xtc_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;generated.xtc&quot;</span>
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;generated.pdb&quot;</span>
        <span class="n">npy_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;path.npy&quot;</span>
        <span class="n">mp4_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;animated_path.mp4&quot;</span>  <span class="c1"># save the cluster as h5 ensemble</span>
        <span class="n">png_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;path.png&quot;</span>  <span class="c1"># save the cluster as h5 ensemble</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="s2">&quot;lowd.csv&quot;</span>            <span class="c1"># A csv file for later plotting the lowd</span>
        <span class="n">md_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="s2">&quot;README.md&quot;</span>            <span class="c1"># A readme filled by jinja</span>
        <span class="c1"># fmt: on</span>

        <span class="c1"># save the path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span><span class="o">.</span><span class="n">save_pdb</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_output</span><span class="o">.</span><span class="n">save_xtc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xtc_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save the path</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">npy_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># create an animation</span>
        <span class="c1"># with tempfile.TemporaryDirectory() as td:</span>
        <span class="c1">#     td = Path(td)</span>
        <span class="c1">#     mov = MovieMaker(</span>
        <span class="c1">#         view=self.view,</span>
        <span class="c1">#         download_folder=str(td),</span>
        <span class="c1">#         # perframe_hook=self.update,</span>
        <span class="c1">#         output=&quot;my.gif&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     mov.make()</span>
        <span class="c1">#     print(list(td.glob(&quot;*&quot;)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save the lowd as csv</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">CV</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lowd&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LOWD FEATURE 0&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LOWD FEATURE 1&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save a png similar to cluster</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">_plot_free_energy</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">lod</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">colorbar_x</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">plot_trajs_by_parameter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">,</span>
                <span class="s2">&quot;traj_num&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">colorscale</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">get_colorscale</span><span class="p">(</span><span class="s2">&quot;Viridis&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s2">&quot;xaxis1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;xaxis2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;yaxis1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;yaxis2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">png_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;kaleido&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save a README</span>
        <span class="c1"># Local Folder Imports</span>
        <span class="kn">from</span> <span class="nn">.._version</span> <span class="kn">import</span> <span class="n">get_versions</span>

        <span class="n">_ensemble_type</span> <span class="o">=</span> <span class="s2">&quot;single traj&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;TrajEnsemble&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_trajs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_ensemble_type</span> <span class="o">=</span> <span class="s2">&quot;trajectory ensemble&quot;</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
            <span class="s2">&quot;system_user&quot;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
            <span class="s2">&quot;platform_release&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span>
            <span class="s2">&quot;platform_version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span>
            <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">(),</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()),</span>
            <span class="s2">&quot;mac_address&quot;</span><span class="p">:</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%012x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">getnode</span><span class="p">())),</span>
            <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">processor</span><span class="p">(),</span>
            <span class="s2">&quot;ram&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot; GB&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pip_freeze&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">freeze</span><span class="p">())),</span>
            <span class="s2">&quot;n_frames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span>
            <span class="s2">&quot;n_trajs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_trajs</span><span class="p">,</span>
            <span class="s2">&quot;n_top&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>
            <span class="s2">&quot;encodermap_version&quot;</span><span class="p">:</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">md_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
            <span class="s2">&quot;ensemble_type&quot;</span><span class="p">:</span> <span class="n">_ensemble_type</span><span class="p">,</span>
            <span class="s2">&quot;csv_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;pdb_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">pdb_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;xtc_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">xtc_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;npy_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">npy_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;autoencoder_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;chosen_top&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_selector</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">top_selector</span><span class="o">.</span><span class="n">value</span><span class="p">],</span>
            <span class="s2">&quot;lowd_dim&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># assert _check_all_templates_defined(PATH_TEMPLATE, info_dict)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">PATH_TEMPLATE</span><span class="p">)</span>
        <span class="n">readme_text</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span>
        <span class="n">md_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">readme_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_save_cluster_on_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the cluster in self.cluster_output to disk.</span>

<span class="sd">        Also writes a README.md and puts images into a directory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">_datetime_windows_and_linux_compatible</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;clusters/</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">output</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cluster_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># define some files</span>
        <span class="c1"># fmt: off</span>
        <span class="n">h5_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">cluster_num</span><span class="si">}</span><span class="s2">.h5&quot;</span>  <span class="c1"># save the cluster as h5 ensemble</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">cluster_num</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># the complete ensemble as a pandas array</span>
        <span class="n">md_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="s2">&quot;README.md&quot;</span>  <span class="c1"># A readme filled by jinja</span>
        <span class="n">png_name</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">cluster_num</span><span class="si">}</span><span class="s2">.png&quot;</span>  <span class="c1"># A render of the cluster</span>
        <span class="n">npy_file</span> <span class="o">=</span> <span class="n">output</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">cluster_num</span><span class="si">}</span><span class="s2">_selector.npy&quot;</span>  <span class="c1"># The xs and ys of the selector</span>
        <span class="c1"># fmt: on</span>

        <span class="c1"># save the cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">h5_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save the pandas</span>
        <span class="n">CVs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lowd&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">AngleDihedralCartesianEncoderMap</span><span class="p">):</span>
            <span class="n">CVs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;central_dihedrals&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">use_backbone_angles</span><span class="p">:</span>
                <span class="n">CVs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;central_angles&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">use_sidechains</span><span class="p">:</span>
                <span class="n">CVs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;side_dihedrals&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">CV</span><span class="o">=</span><span class="n">CVs</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; FEATURE&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LOWD FEATURE 0&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LOWD FEATURE 1&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save the selector</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">ys</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">npy_file</span><span class="p">,</span> <span class="n">verts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># create a png</span>
        <span class="c1"># the png is already saved in /tmp.json</span>
        <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/tmp/tmp.png&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">_plot_free_energy</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">set_env</span><span class="p">(</span><span class="n">ENCODERMAP_SKIP_SCATTER_SIZE_CHECK</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">plot_trajs_by_parameter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_col</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
                    <span class="n">z_name_overwrite</span><span class="o">=</span><span class="s2">&quot;cluster id&quot;</span><span class="p">,</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">colorscale</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">get_colorscale</span><span class="p">(</span><span class="s2">&quot;Viridis&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s2">&quot;xaxis1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;xaxis2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;xaxis3&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;showticklabels&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;yaxis1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;yaxis2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">},</span>
                <span class="s2">&quot;yaxis3&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;showticklabels&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;coloraxis_showscale&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">coloraxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">selector</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">png_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;kaleido&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># save a README</span>
        <span class="c1"># Local Folder Imports</span>
        <span class="kn">from</span> <span class="nn">.._version</span> <span class="kn">import</span> <span class="n">get_versions</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
            <span class="s2">&quot;system_user&quot;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
            <span class="s2">&quot;platform_release&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span>
            <span class="s2">&quot;platform_version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span>
            <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">(),</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()),</span>
            <span class="s2">&quot;mac_address&quot;</span><span class="p">:</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%012x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">getnode</span><span class="p">())),</span>
            <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">processor</span><span class="p">(),</span>
            <span class="s2">&quot;ram&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot; GB&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pip_freeze&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">freeze</span><span class="p">())),</span>
            <span class="s2">&quot;h5_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">h5_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;n_frames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span>
            <span class="s2">&quot;n_trajs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_trajs</span><span class="p">,</span>
            <span class="s2">&quot;n_top&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>
            <span class="s2">&quot;cluster_num&quot;</span><span class="p">:</span> <span class="n">cluster_num</span><span class="p">,</span>
            <span class="s2">&quot;h5_info&quot;</span><span class="p">:</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">H5_INFO</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;h5_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">h5_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">())}</span>
            <span class="p">),</span>
            <span class="s2">&quot;encodermap_version&quot;</span><span class="p">:</span> <span class="n">get_versions</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">md_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
            <span class="s2">&quot;csv_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()),</span>
        <span class="p">}</span>
        <span class="c1"># assert _check_all_templates_defined(CLUSTER_TEMPLATE, info_dict)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">CLUSTER_TEMPLATE</span><span class="p">)</span>
        <span class="n">readme_text</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">info_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">md_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">readme_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># cleanup</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>

<div class="viewcode-block" id="InteractivePlotting.scatter_on_click">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.scatter_on_click">[docs]</a>
    <span class="k">def</span> <span class="nf">scatter_on_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">selector</span><span class="p">):</span>
        <span class="c1"># clear the display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># get the id of the clicked point</span>
        <span class="n">point_id</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># display a message</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Displaying conformation </span><span class="si">{</span><span class="n">point_id</span><span class="si">}</span><span class="s2"> for &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span><span class="p">[</span><span class="n">point_id</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span><span class="p">[</span><span class="n">point_id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Can&#39;t display point </span><span class="si">{</span><span class="n">point_id</span><span class="si">}</span><span class="s2"> due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. The &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;shapes of the file and frame arrays are &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># color the main plot</span>
        <span class="c1"># c = self.base_colors.copy()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_sizes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># c[point_id] = &quot;#ff7f0e&quot;</span>
        <span class="n">s</span><span class="p">[</span><span class="n">point_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="o">.</span><span class="n">batch_update</span><span class="p">():</span>
            <span class="c1"># self.scatter_data.marker.color = c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span>

        <span class="c1"># plot the trace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highd</span><span class="p">[</span><span class="n">point_id</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># nglview</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">get_single_frame</span><span class="p">(</span><span class="n">point_id</span><span class="p">)</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">center_coordinates</span><span class="p">()</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_and_stick</span><span class="p">:</span>
            <span class="n">view</span><span class="o">.</span><span class="n">clear_representations</span><span class="p">()</span>
            <span class="n">view</span><span class="o">.</span><span class="n">add_representation</span><span class="p">(</span><span class="s2">&quot;ball+stick&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>

        <span class="c1"># pandas</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">dash_summary</span><span class="p">())</span></div>


<div class="viewcode-block" id="InteractivePlotting.on_select">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.on_select">[docs]</a>
    <span class="k">def</span> <span class="nf">on_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">selector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        <span class="c1"># c = self.base_colors.copy()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_sizes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># c[self.selected_point_ids] = &quot;#2ca02c&quot;</span>
        <span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="o">.</span><span class="n">batch_update</span><span class="p">():</span>
            <span class="c1"># self.scatter_data.marker.color = c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> points. Hit &#39;cluster&#39; to view.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="InteractivePlotting.switch_between_density_and_scatter">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.switch_between_density_and_scatter">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_between_density_and_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">],</span>
                <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                    <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span>
            <span class="c1"># self.figure_widget.data[0].visible = False</span>
            <span class="c1"># self.figure_widget.data[1].visible = True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="s2">&quot;density&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="p">],</span>
                <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                    <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span>
            <span class="c1"># self.figure_widget.data[0].visible = True</span>
            <span class="c1"># self.figure_widget.data[1].visible = False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span></div>


<div class="viewcode-block" id="InteractivePlotting.help">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.help">[docs]</a>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># Third Party Imports</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Javascript</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Javascript</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;window.open(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_url</span><span class="o">.</span><span class="n">tooltip</span><span class="si">}</span><span class="s1">&quot;);&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="InteractivePlotting.on_canvas_mouse_down">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.on_canvas_mouse_down">[docs]</a>
    <span class="k">def</span> <span class="nf">on_canvas_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_drawing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span><span class="p">]</span></div>


<div class="viewcode-block" id="InteractivePlotting.on_canvas_mouse_up">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.on_canvas_mouse_up">[docs]</a>
    <span class="k">def</span> <span class="nf">on_canvas_mouse_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_drawing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Select a topology from the Dropdown menu and hit &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;Gnerate&#39; to generate new molecular conformations.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Click &#39;Generate&#39; to generate new molecular conformations&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="InteractivePlotting.on_canvas_mouse_move">
<a class="viewcode-back" href="../../../api/index.html#encodermap.InteractivePlotting.on_canvas_mouse_move">[docs]</a>
    <span class="k">def</span> <span class="nf">on_canvas_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_drawing</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">hold_canvas</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">stroke_line</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_canvas_path_in_data_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the path coordinates in data coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: An array of shape (n_points, 2) containing the</span>
<span class="sd">                data coordinates. [:, 0] are the x-coordinates and</span>
<span class="sd">                [:, 1] are the y-coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Third Party Imports</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas_path</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">range</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">([</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">verts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">distance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">verts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">fx</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">fy</span><span class="p">(</span><span class="n">alpha</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_setup_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># text areas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">GridspecLayout</span><span class="p">(</span><span class="n">n_rows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_columns</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;1000px&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;h2&gt;EncoderMap Dashboard for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_main_path</span><span class="si">}</span><span class="s2">&lt;/h2&gt;&quot;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Interact with the Scatter Plot to view molecular conformations. &quot;</span>
                <span class="s2">&quot;Select points with the lasso tool and click &#39;cluster&#39; &quot;</span>
                <span class="s2">&quot;to generate a cluster. Switch to &#39;Density&#39; to draw a Path and &quot;</span>
                <span class="s2">&quot;generate new conformations.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># the traj options</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;&lt;mdtraj.Topology with &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">common_str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">top</span><span class="p">,</span> <span class="n">sub_trajs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">trajs_by_top</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_trajs</span><span class="o">.</span><span class="n">common_str</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">common_str</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_selector</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Top:&quot;</span><span class="p">)</span>

        <span class="c1"># some placeholders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pandas_all_area</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># slider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_slider_len</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Size&quot;</span><span class="p">,</span>
            <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># buttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;a href=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_url</span><span class="si">}</span><span class="s1">&gt;&lt;div class=&quot;lm-Widget jupyter-widgets &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;jupyter-button widget-button mod-info&quot; style=&quot;height: 50%; &#39;</span>
                <span class="sa">f</span><span class="s2">&quot;width: 100%; grid-area: widget007; margin: auto; margin-top: 25px; display: &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;flex; align-items: center; justify-content: center;&quot;&gt;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;i class=&quot;fa fa-info&quot;&gt;&lt;/i&gt;Help&lt;/div&gt;&lt;/a&gt;&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cluster&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;th&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;After selecting points with the Lasso Tool, this button will &quot;</span>
                <span class="s2">&quot;display a subset of the selected point in the display area. Use &quot;</span>
                <span class="s2">&quot;the &#39;Size&#39; slider to choose how many representative structures of &quot;</span>
                <span class="s2">&quot;the selected cluster you want to have displayed.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;bezier-curve&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Use the decoder part of the autoencoder to create new molecular &quot;</span>
                <span class="s2">&quot;conformations from a path, that you have drawn with the &#39;Draw &quot;</span>
                <span class="s2">&quot;open freeform&#39; Tool. The &#39;Size&#39; slider will choose how many &quot;</span>
                <span class="s2">&quot;conformations to create along the path.&quot;</span>
            <span class="p">),</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;floppy-o&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;bar-chart&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">),</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;This button toggles between a density and a scatter plot.&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heatmap</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># this array prepares the selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_point_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># set up the canvas for drawing</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;yaxis_visible&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xaxis_visible&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">background_image</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_image</span><span class="p">(</span><span class="n">background_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_drawing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">on_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_canvas_mouse_down</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_canvas_mouse_move</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">on_mouse_up</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_canvas_mouse_up</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">stroke_style</span> <span class="o">=</span> <span class="s2">&quot;#749cb8&quot;</span>

        <span class="c1"># main figure widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker_colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowd</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_sizes</span>

        <span class="c1"># the animation widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_anim_widget</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Generation Path (%</span><span class="si">{x:.2f}</span><span class="s2">, %</span><span class="si">{y:.2f}</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                    <span class="n">marker_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">marker_line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Current Path (%</span><span class="si">{x:.2f}</span><span class="s2">, %</span><span class="si">{y:.2f}</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># the trace widget</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_widget</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">heatmap</span><span class="p">],</span>
                <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                        <span class="s2">&quot;modebar_remove&quot;</span><span class="p">:</span> <span class="n">BAD_MODEBAR_BUTTONS</span><span class="p">,</span>
                        <span class="s2">&quot;yaxis_visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;xaxis_visible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Trace&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                        <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                            <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
                            <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># responsiveness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_on_click</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_data</span><span class="o">.</span><span class="n">on_selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_select</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_between_density_and_scatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">)</span>

        <span class="c1"># add the elements to the grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_widget</span><span class="p">],</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">highd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_widget</span><span class="p">],</span>
                <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
                    <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngl_area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progbar_empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">8</span><span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas_all_area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">[</span><span class="mi">8</span><span class="p">:,</span> <span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas_info_area</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas_all_area</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajs</span><span class="o">.</span><span class="n">dash_summary</span><span class="p">())</span>

        <span class="c1"># self.container = widgets.VBox([</span>
        <span class="c1">#     self.header,</span>
        <span class="c1">#     self.display,</span>
        <span class="c1">#     self.figure_widget,</span>
        <span class="c1"># ])</span>

        <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span></div>



<span class="c1"># class InteractivePlottingDep:</span>
<span class="c1">#     &quot;&quot;&quot;Class to open up an interactive plotting window.</span>
<span class="c1">#</span>
<span class="c1">#     Contains subclasses to handle user-clickable menus and selectors.</span>
<span class="c1">#</span>
<span class="c1">#     Attributes:</span>
<span class="c1">#         trajs (encodermap.TrajEnsemble): The trajs passed into this class.</span>
<span class="c1">#         fig (matplotlib.figure): The figure plotted onto. If ax is passed when</span>
<span class="c1">#             this class is instantiated, the parent figure will be fetched with</span>
<span class="c1">#             self.fig = self.ax.get_figure()</span>
<span class="c1">#         ax (matplotlib.axes): The axes where the lowd data of the trajs</span>
<span class="c1">#             is plotted on.</span>
<span class="c1">#         menu_ax (matplotlib.axes): The axes where the normal menu is plotted on.</span>
<span class="c1">#         status_menu_ax (matplotlib.axes): The axes on which the status menu is plotted on.</span>
<span class="c1">#         pts (matplotlib.collections.Collection): The points which are plotted. Based on some</span>
<span class="c1">#             other class variables, the color of this collection is adjusted.</span>
<span class="c1">#         statusmenu (encodermap.plot.utils.StatusMenu): The menu containing the</span>
<span class="c1">#             status buttons.</span>
<span class="c1">#         menu (encodermap.plot.utils.Menu): The menu containing the remaining buttons.</span>
<span class="c1">#         tool (encodermap.plot.utils.SelectFromCollection): The current active</span>
<span class="c1">#             tool used to select points. This can be lasso, polygon, etc...</span>
<span class="c1">#         mode (str): Current mode of the statusmenu.</span>
<span class="c1">#</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(</span>
<span class="c1">#         self,</span>
<span class="c1">#         autoencoder,</span>
<span class="c1">#         trajs=None,</span>
<span class="c1">#         data=None,</span>
<span class="c1">#         ax=None,</span>
<span class="c1">#         align_string=&quot;name CA&quot;,</span>
<span class="c1">#         top=None,</span>
<span class="c1">#         hist=False,</span>
<span class="c1">#         scatter_kws={&quot;s&quot;: 5},</span>
<span class="c1">#         ball_and_stick=False,</span>
<span class="c1">#         top_index=0,</span>
<span class="c1">#     ):</span>
<span class="c1">#         &quot;&quot;&quot;Instantiate the InteractivePlotting class.</span>
<span class="c1">#</span>
<span class="c1">#         Args:</span>
<span class="c1">#             trajs (encodermap.TrajEnsemble): The trajs of which the lowd info</span>
<span class="c1">#                 should be plotted.</span>
<span class="c1">#             ax (matplotlib.axes, optional): On what axes to plot. If no axis is provided</span>
<span class="c1">#                 a new figure and axes will be created, defaults to None.</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # the align string for the cluster dummy method</span>
<span class="c1">#         self.align_string = align_string</span>
<span class="c1">#         self.top = top</span>
<span class="c1">#         self.hist = hist</span>
<span class="c1">#         self.autoencoder = autoencoder</span>
<span class="c1">#         self.ball_and_stick = ball_and_stick</span>
<span class="c1">#         self.top_index = top_index</span>
<span class="c1">#</span>
<span class="c1">#         # scatter kws</span>
<span class="c1">#         self.scatter_kws = {**{&quot;s&quot;: 80, &quot;alpha&quot;: 0.5}, **scatter_kws}</span>
<span class="c1">#</span>
<span class="c1">#         # close all plots</span>
<span class="c1">#         plt.close(&quot;all&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         # decide on fate of data</span>
<span class="c1">#         if data is None:</span>
<span class="c1">#             if hasattr(trajs, &quot;lowd&quot;):</span>
<span class="c1">#                 print(&quot;Using the attribute `lowd` of provided `trajs`&quot;)</span>
<span class="c1">#                 data = trajs.lowd</span>
<span class="c1">#             elif isinstance(trajs, (TrajEnsemble, SingleTraj)) and (</span>
<span class="c1">#                 isinstance(autoencoder, AngleDihedralCartesianEncoderMap)</span>
<span class="c1">#                 or autoencoder.__class__.__name__ == &quot;AngleDihedralCartesianEncoderMap&quot;</span>
<span class="c1">#             ):</span>
<span class="c1">#                 print(</span>
<span class="c1">#                     &quot;Using the provided `autoencoder` and `trajs` to create a projection.&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#                 data = autoencoder.encode(trajs)</span>
<span class="c1">#             elif isinstance(data, np.ndarray) and hasattr(autoencoder, &quot;encode&quot;):</span>
<span class="c1">#                 print(&quot;Using the `encode` method of `autoencoder` with provided data.&quot;)</span>
<span class="c1">#                 if np.any(np.isnan(data)):</span>
<span class="c1">#                     # Third Party Imports</span>
<span class="c1">#                     import tensorflow as tf</span>
<span class="c1">#</span>
<span class="c1">#                     indices = np.stack(np.where(~np.isnan(data))).T.astype(&quot;int64&quot;)</span>
<span class="c1">#                     dense_shape = data.shape</span>
<span class="c1">#                     values = data[~np.isnan(data)].flatten().astype(&quot;float32&quot;)</span>
<span class="c1">#                     data = tf.sparse.SparseTensor(indices, values, dense_shape)</span>
<span class="c1">#                 data = autoencoder.encode(data)</span>
<span class="c1">#             elif hasattr(autoencoder, &quot;encode&quot;):</span>
<span class="c1">#                 print(&quot;Using the `train_data` attribute of `autoencoder`.&quot;)</span>
<span class="c1">#                 data = autoencoder.encode()</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(&quot;Mocking data with np.random&quot;)</span>
<span class="c1">#                 np.random.seed(19680801)</span>
<span class="c1">#                 data = np.random.rand(100, 2)</span>
<span class="c1">#         if data.shape[1] != 2:</span>
<span class="c1">#             print(&quot;Using provided `data` to call encoder.&quot;)</span>
<span class="c1">#             data = autoencoder.encode(data)</span>
<span class="c1">#         self.data = data</span>
<span class="c1">#</span>
<span class="c1">#         # see what traj has been provided</span>
<span class="c1">#         if trajs is None:</span>
<span class="c1">#             self.trajs = autoencoder.trajs</span>
<span class="c1">#         else:</span>
<span class="c1">#             if isinstance(trajs, str):</span>
<span class="c1">#                 self.trajs = SingleTraj(trajs, self.top, traj_num=0)._gen_ensemble()</span>
<span class="c1">#             elif isinstance(trajs, list):</span>
<span class="c1">#                 self.trajs = TrajEnsemble(trajs, self.top)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.trajs = trajs</span>
<span class="c1">#</span>
<span class="c1">#         if isinstance(trajs, SingleTraj):</span>
<span class="c1">#             if &quot;lowd&quot; not in self.trajs.CVs:</span>
<span class="c1">#                 self.trajs.load_CV(self.data, attr_name=&quot;lowd&quot;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             if &quot;lowd&quot; not in self.trajs.CVs:</span>
<span class="c1">#                 self.trajs.load_CVs(self.data, attr_name=&quot;lowd&quot;)</span>
<span class="c1">#</span>
<span class="c1">#         # decide what function to use to build clusters</span>
<span class="c1">#         # Decided against gen_dummy traj as get_cluster_frames works better with jinja2</span>
<span class="c1">#         self.cluster_building_fn = get_cluster_frames</span>
<span class="c1">#</span>
<span class="c1">#         # create fig and ax</span>
<span class="c1">#         if ax is None:</span>
<span class="c1">#             # create fig and ax</span>
<span class="c1">#             subplot_kw = dict(xlim=(0, 1), ylim=(0, 1), autoscale_on=True)</span>
<span class="c1">#             self.fig, self.ax = plt.subplots(</span>
<span class="c1">#                 1, 1, figsize=(10, 8)</span>
<span class="c1">#             )  # subplot_kw=subplot_kw)</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.ax = ax</span>
<span class="c1">#             self.fig = self.ax.get_figure()</span>
<span class="c1">#</span>
<span class="c1">#         # add the axes to create the menus on</span>
<span class="c1">#         self.fig.subplots_adjust(left=0.3)</span>
<span class="c1">#         self.menu_ax = plt.axes([0.05, 0.1, 0.15, 0.35], facecolor=&quot;lightblue&quot;)</span>
<span class="c1">#         self.status_menu_ax = plt.axes(</span>
<span class="c1">#             [0.05, 0.49, 0.15, 0.35], facecolor=&quot;lightyellow&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # remove everything in these axes</span>
<span class="c1">#         self.menu_ax.axis(&quot;off&quot;)</span>
<span class="c1">#         self.status_menu_ax.axis(&quot;off&quot;)</span>
<span class="c1">#         self.tool = DummyTool()</span>
<span class="c1">#</span>
<span class="c1">#         # plot</span>
<span class="c1">#         self.pts = self.ax.scatter(self.data[:, 0], self.data[:, 1], **self.scatter_kws)</span>
<span class="c1">#</span>
<span class="c1">#         # hist</span>
<span class="c1">#         if self.hist:</span>
<span class="c1">#             self.ax.hist2d(*data.T, bins=400, norm=mpl.colors.LogNorm())</span>
<span class="c1">#</span>
<span class="c1">#         # Check whether mouse enters drawing area</span>
<span class="c1">#         # Upon entering drawing area tools are initialized based on current mode</span>
<span class="c1">#         # Leave event currently serves no purpose</span>
<span class="c1">#         self.cid_ax_enter = self.fig.canvas.mpl_connect(</span>
<span class="c1">#             &quot;axes_enter_event&quot;, self.on_enter_ax</span>
<span class="c1">#         )</span>
<span class="c1">#         self.cid_ax_leave = self.fig.canvas.mpl_connect(</span>
<span class="c1">#             &quot;axes_leave_event&quot;, self.on_leave_ax</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # chech button presses and compare them with the status of the menuitems</span>
<span class="c1">#         self.cid_on_click = self.fig.canvas.mpl_connect(</span>
<span class="c1">#             &quot;button_release_event&quot;, self.on_click</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # Instantiate Menu</span>
<span class="c1">#         self.statusmenu = StatusMenu(self.status_menu_ax)</span>
<span class="c1">#         self.menu = Menu(self.menu_ax)</span>
<span class="c1">#</span>
<span class="c1">#         # Show</span>
<span class="c1">#         plt.show()</span>
<span class="c1">#</span>
<span class="c1">#     def on_click(self, event):</span>
<span class="c1">#         &quot;&quot;&quot;Decides whether the release event happened in the drawing area or the menu.</span>
<span class="c1">#</span>
<span class="c1">#         Args:</span>
<span class="c1">#             event (matplotlib.backend_bases.Event): The event provided by figure.canvas.connect().</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if event.inaxes == self.ax:</span>
<span class="c1">#             self.on_click_tool(event)</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.on_click_menu(event)</span>
<span class="c1">#</span>
<span class="c1">#     def on_enter_ax(self, event):</span>
<span class="c1">#         &quot;&quot;&quot;Chosses the tool to use when self.ax is entered, based on current mode.</span>
<span class="c1">#</span>
<span class="c1">#         Args:</span>
<span class="c1">#             event (matplotlib.backend_bases.Event): The event provided by figure.canvas.connect().</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         # print(&#39;Axis is entered&#39;)</span>
<span class="c1">#         if event.inaxes is self.ax and self.mode == &quot;Idle&quot;:</span>
<span class="c1">#             # reset point coloration</span>
<span class="c1">#             self.pts.set_color(&quot;C0&quot;)</span>
<span class="c1">#             self.tool.disconnect()</span>
<span class="c1">#         if event.inaxes is self.ax and self.mode != &quot;Idle&quot;:</span>
<span class="c1">#             # statusmenu</span>
<span class="c1">#             for key, item in self.statusmenu.menuitems.items():</span>
<span class="c1">#                 if self.mode == key:</span>
<span class="c1">#                     method = getattr(self, key.lower())</span>
<span class="c1">#                     method()</span>
<span class="c1">#</span>
<span class="c1">#     def on_leave_ax(self, event):</span>
<span class="c1">#         &quot;&quot;&quot;Disconnect the current tool.&quot;&quot;&quot;</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#     def on_click_tool(self, event):</span>
<span class="c1">#         &quot;&quot;&quot;Left here for convenience if some tools need a button release event.&quot;&quot;&quot;</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     ick_menu(self, event):</span>
<span class="c1">#         &quot;&quot;&quot;Chooses the function to call based on what MenuItem was clicked.</span>
<span class="c1">#</span>
<span class="c1">#         Args:</span>
<span class="c1">#             event (matplotlib.backend_bases.Event): The event provided by figure.canvas.connect().</span>
<span class="c1">#</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         for key, item in self.menu.menuitems.items():</span>
<span class="c1">#             if item.check_select(event):</span>
<span class="c1">#                 method = getattr(self, key.lower().replace(&quot; &quot;, &quot;_&quot;))</span>
<span class="c1">#                 method()</span>
<span class="c1">#</span>
<span class="c1">#     def reset(self):</span>
<span class="c1">#         &quot;&quot;&quot;Called when &#39;Reset&#39; is pressed.&quot;&quot;&quot;</span>
<span class="c1">#         if &quot;user_selected_points&quot; in self.trajs.CVs:</span>
<span class="c1">#             self.trajs._CVs.drop(labels=&quot;user_selected_points&quot;)</span>
<span class="c1">#         self.__init__(</span>
<span class="c1">#             self.trajs,</span>
<span class="c1">#             self.autoencoder,</span>
<span class="c1">#             self.data,</span>
<span class="c1">#             None,</span>
<span class="c1">#             self.align_string,</span>
<span class="c1">#             self.top,</span>
<span class="c1">#             self.hist,</span>
<span class="c1">#             self.scatter_kws,</span>
<span class="c1">#             self.ball_and_stick,</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#     def write(self):</span>
<span class="c1">#         &quot;&quot;&quot;Called when &#39;Write&#39; is pressed.&quot;&quot;&quot;</span>
<span class="c1">#         if self.mode == &quot;Idle&quot;:</span>
<span class="c1">#             return</span>
<span class="c1">#         time = _datetime_windows_and_linux_compatible()</span>
<span class="c1">#         if self.mode == &quot;Bezier&quot; or self.mode == &quot;Path&quot;:</span>
<span class="c1">#             os.makedirs(</span>
<span class="c1">#                 f&quot;{self.autoencoder.p.main_path}/generated_paths/&quot;, exist_ok=True</span>
<span class="c1">#             )</span>
<span class="c1">#             fname = (</span>
<span class="c1">#                 f&quot;{self.autoencoder.p.main_path}/generated_paths/generated_{time}.pdb&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#             with mda.Writer(fname) as w:</span>
<span class="c1">#                 for step in self.uni.trajectory:</span>
<span class="c1">#                     w.write(self.uni.atoms)</span>
<span class="c1">#             self.ax.set_title(</span>
<span class="c1">#                 f&quot;Generated Path with {len(generated)} points saved at {fname}&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#         else:</span>
<span class="c1">#             if &quot;user_selected_points&quot; not in self.trajs.CVs:</span>
<span class="c1">#                 self.ax.set_title(&quot;First set the points before writing them to disk.&quot;)</span>
<span class="c1">#                 return</span>
<span class="c1">#             max_, fname = _unpack_cluster_info(</span>
<span class="c1">#                 self.trajs,</span>
<span class="c1">#                 self.autoencoder.p.main_path,</span>
<span class="c1">#                 self.tool,</span>
<span class="c1">#                 self.dummy_traj,</span>
<span class="c1">#                 self.align_string,</span>
<span class="c1">#             )</span>
<span class="c1">#             self.ax.set_title(f&quot;Cluster {max_} saved at {fname}&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     def set_points(self):</span>
<span class="c1">#         &quot;&quot;&quot;Called when &#39;Set Points&#39; is pressed.&quot;&quot;&quot;</span>
<span class="c1">#         if self.mode == &quot;Idle&quot;:</span>
<span class="c1">#             return</span>
<span class="c1">#         if self.mode != &quot;Idle&quot;:</span>
<span class="c1">#             if &quot;tool&quot; not in self.__dict__.keys():</span>
<span class="c1">#                 self.ax.set_title(f&quot;Tool {self.mode} not yet implemented.&quot;)</span>
<span class="c1">#                 return</span>
<span class="c1">#             else:</span>
<span class="c1">#                 indices = self.accept()</span>
<span class="c1">#         if self.mode == &quot;Bezier&quot; or self.mode == &quot;Path&quot;:</span>
<span class="c1">#             if np.unique(self.path_points, axis=0).shape[0] != 200:</span>
<span class="c1">#                 self.ax.set_title(</span>
<span class="c1">#                     f&quot;Tool {self.mode} returned not the requested unique points.&quot;</span>
<span class="c1">#                 )</span>
<span class="c1">#                 return</span>
<span class="c1">#             self.dummy_traj = self.autoencoder.generate(</span>
<span class="c1">#                 self.path_points, backend=&quot;mdanalysis&quot;, top=self.top_index</span>
<span class="c1">#             )</span>
<span class="c1">#             self.view = ngl.show_mdanalysis(self.dummy_traj)</span>
<span class="c1">#             if self.ball_and_stick:</span>
<span class="c1">#                 self.view.clear_representations()</span>
<span class="c1">#                 self.view.add_ball_and_stick()</span>
<span class="c1">#</span>
<span class="c1">#             self.ax.set_title(</span>
<span class="c1">#                 f&quot;Generated Path with {len(self.dummy_traj.trajectory)} points is accessible as InteractivePlotting.view.&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#             return</span>
<span class="c1">#</span>
<span class="c1">#         if indices is not None and self.mode != &quot;Bezier&quot; and self.mode != &quot;Path&quot;:</span>
<span class="c1">#             self.ax.set_title(</span>
<span class="c1">#                 f&quot;Currently working on rendering the cluster. I&#39;ll let you know, when I&#39;m finished.&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#             indices = np.asarray(indices)</span>
<span class="c1">#</span>
<span class="c1">#             # update user defined clustering</span>
<span class="c1">#             col = &quot;user_selected_points&quot;</span>
<span class="c1">#             if col not in self.trajs.CVs:</span>
<span class="c1">#                 _ = np.full(self.trajs.n_frames, -1)</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     _[indices] = 0</span>
<span class="c1">#                 except IndexError as e:</span>
<span class="c1">#                     print(indices)</span>
<span class="c1">#                     raise SystemExit from e</span>
<span class="c1">#                 self.trajs.load_CVs(_, col)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 _ = self.trajs.CVs[col]</span>
<span class="c1">#                 max_ = _.max()</span>
<span class="c1">#                 _[indices] = max_ + 1</span>
<span class="c1">#                 self.trajs.load_CVs(_, col)</span>
<span class="c1">#</span>
<span class="c1">#             # change coloration of self.pts</span>
<span class="c1">#             color_palette = sns.color_palette(&quot;Paired&quot;, self.trajs.CVs[col].max() + 1)</span>
<span class="c1">#             cluster_colors = [</span>
<span class="c1">#                 (*color_palette[x], 1) if x &gt;= 0 else (0.5, 0.5, 0.5, 0.01)</span>
<span class="c1">#                 for x in self.trajs.CVs[col]</span>
<span class="c1">#             ]</span>
<span class="c1">#             self.pts.set_color(cluster_colors)</span>
<span class="c1">#</span>
<span class="c1">#             max_ = np.max(self.trajs.CVs[col])</span>
<span class="c1">#             self.view, self.dummy_traj = self.cluster_building_fn(</span>
<span class="c1">#                 self.trajs,</span>
<span class="c1">#                 max_,</span>
<span class="c1">#                 nglview=True,</span>
<span class="c1">#                 shorten=True,</span>
<span class="c1">#                 stack_atoms=True,</span>
<span class="c1">#                 col=col,</span>
<span class="c1">#                 align_string=self.align_string,</span>
<span class="c1">#                 ball_and_stick=self.ball_and_stick,</span>
<span class="c1">#             )</span>
<span class="c1">#             if self.ball_and_stick:</span>
<span class="c1">#                 for i in range(len(self.dummy_traj)):</span>
<span class="c1">#                     self.view.clear_representations(component=i)</span>
<span class="c1">#                     self.view.add_ball_and_stick(component=i)</span>
<span class="c1">#             self.ax.set_title(</span>
<span class="c1">#                 f&quot;Cluster {max_} is accessible as InteractivePlotting.view.&quot;</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#     def render_move(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#     def lasso(self):</span>
<span class="c1">#         self.tool = SelectFromCollection(self.ax, self.pts)</span>
<span class="c1">#</span>
<span class="c1">#     def rectangle(self):</span>
<span class="c1">#         self.tool = SelectFromCollection(self.ax, self.pts, selector=RectangleSelector)</span>
<span class="c1">#</span>
<span class="c1">#     def ellipse(self):</span>
<span class="c1">#         print(&quot;Ellipse not yet implemented&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     def polygon(self):</span>
<span class="c1">#         textstr = &quot;\n&quot;.join(</span>
<span class="c1">#             (</span>
<span class="c1">#                 &quot;Select points in the figure by enclosing them within a polygon.&quot;,</span>
<span class="c1">#                 # Press the &#39;esc&#39; key to start a new polygon.</span>
<span class="c1">#                 &quot;Try holding the &#39;shift&#39; key to move all of the vertices.&quot;,</span>
<span class="c1">#                 &quot;Try holding the &#39;ctrl&#39; key to move a single vertex.&quot;,</span>
<span class="c1">#             )</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#         # these are matplotlib.patch.Patch properties</span>
<span class="c1">#         props = dict(boxstyle=&quot;round&quot;, facecolor=&quot;wheat&quot;, alpha=0.5)</span>
<span class="c1">#</span>
<span class="c1">#         # place a text box in upper left in axes coords</span>
<span class="c1">#         self.manual_text = self.ax.text(</span>
<span class="c1">#             0.05,</span>
<span class="c1">#             0.95,</span>
<span class="c1">#             textstr,</span>
<span class="c1">#             transform=self.ax.transAxes,</span>
<span class="c1">#             fontsize=6,</span>
<span class="c1">#             verticalalignment=&quot;top&quot;,</span>
<span class="c1">#             bbox=props,</span>
<span class="c1">#         )</span>
<span class="c1">#         self.tool = SelectFromCollection(self.ax, self.pts, selector=PolygonSelector)</span>
<span class="c1">#</span>
<span class="c1">#     def path(self):</span>
<span class="c1">#         pass</span>
<span class="c1">#</span>
<span class="c1">#     def bezier(self):</span>
<span class="c1">#         line = Line2D([], [], ls=&quot;--&quot;, c=&quot;#666666&quot;, marker=&quot;x&quot;, mew=2, mec=&quot;#204a87&quot;)</span>
<span class="c1">#         self.ax.add_line(line)</span>
<span class="c1">#         self.tool = BezierBuilder(line, self.ax)</span>
<span class="c1">#</span>
<span class="c1">#     def accept(self):</span>
<span class="c1">#         if &quot;manual_text&quot; in self.__dict__.keys():</span>
<span class="c1">#             self.manual_text.set_visible(False)</span>
<span class="c1">#             del self.manual_text</span>
<span class="c1">#         if self.mode == &quot;Bezier&quot;:</span>
<span class="c1">#             self.path_points = copy.deepcopy(self.tool.ind)</span>
<span class="c1">#         selected_indices = self.tool.ind</span>
<span class="c1">#         self.tool.disconnect()</span>
<span class="c1">#         return selected_indices</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def cluster_zoomed(self):</span>
<span class="c1">#         col = &quot;user_selected_points&quot;</span>
<span class="c1">#         if not col in self.trajs.df.keys():</span>
<span class="c1">#             return</span>
<span class="c1">#         max_ = np.max(self.trajs.df[col])</span>
<span class="c1">#         _ = plot_cluster_zoomed(self.trajs, max_, col=col)</span>
<span class="c1">#         return _</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def mode(self):</span>
<span class="c1">#         return self.statusmenu.status</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Kevin Sawade, Tobias Lemke, University of Konstanz.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 2025-05-15T21:24:25.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">Docs for EncoderMap 3.0.1+10.g67ae638.dirty</div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>