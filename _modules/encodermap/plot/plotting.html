
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>encodermap.plot.plotting &#8212; encodermap 3.0.1+10.g67ae638.dirty documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=c1026b93" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=ea0ca436"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/encodermap/plot/plotting';</script>
    <link rel="icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="3.0.1+10.g67ae638.dirty" />
    <meta name="docbuild:last-update" content="2025-05-15T21:24:25"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo_cube_300.png" class="logo__image only-light" alt="encodermap 3.0.1+10.g67ae638.dirty documentation - Home"/>
    <img src="../../../_static/logo_cube_300.png" class="logo__image only-dark pst-js-only" alt="encodermap 3.0.1+10.g67ae638.dirty documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notebooks/index.html">
    Notebook Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Ag-Peter/encodermap" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notebooks/index.html">
    Notebook Gallery
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contributing/index.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Ag-Peter/encodermap" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../encodermap.html" class="nav-link">encodermap</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">encodermap.plot.plotting</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for encodermap.plot.plotting</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># encodermap/plot/plotting.py</span>
<span class="c1">################################################################################</span>
<span class="c1"># EncoderMap: A python library for dimensionality reduction.</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2019-2024 University of Konstanz and the Authors</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># Kevin Sawade, Tobias Lemke</span>
<span class="c1">#</span>
<span class="c1"># Encodermap is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as</span>
<span class="c1"># published by the Free Software Foundation, either version 2.1</span>
<span class="c1"># of the License, or (at your option) any later version.</span>
<span class="c1"># This package is distributed in the hope that it will be useful to other</span>
<span class="c1"># researches. IT DOES NOT COME WITH ANY WARRANTY WHATSOEVER; without even the</span>
<span class="c1"># implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1"># See the GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># See &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">################################################################################</span>
<span class="sd">&quot;&quot;&quot;Convenience functions for Plotting.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##############################################################################</span>
<span class="c1"># Imports</span>
<span class="c1">##############################################################################</span>


<span class="c1"># Future Imports at the top</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># Standard Library Imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">overload</span>

<span class="c1"># Third Party Imports</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>

<span class="c1"># Encodermap imports</span>
<span class="kn">from</span> <span class="nn">encodermap.encodermap_tf1.misc</span> <span class="kn">import</span> <span class="n">periodic_distance_np</span><span class="p">,</span> <span class="n">sigmoid</span>
<span class="kn">from</span> <span class="nn">encodermap.misc.rotate</span> <span class="kn">import</span> <span class="n">_dihedral</span>
<span class="kn">from</span> <span class="nn">encodermap.parameters.parameters</span> <span class="kn">import</span> <span class="n">AnyParameters</span>
<span class="kn">from</span> <span class="nn">encodermap.trajinfo.info_all</span> <span class="kn">import</span> <span class="n">TrajEnsemble</span>
<span class="kn">from</span> <span class="nn">encodermap.trajinfo.info_single</span> <span class="kn">import</span> <span class="n">SingleTraj</span>


<span class="c1">################################################################################</span>
<span class="c1"># Typing</span>
<span class="c1">################################################################################</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
    <span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>


<span class="c1">################################################################################</span>
<span class="c1"># Optional Imports</span>
<span class="c1">################################################################################</span>


<span class="c1"># Third Party Imports</span>
<span class="kn">from</span> <span class="nn">optional_imports</span> <span class="kn">import</span> <span class="n">_optional_import</span>


<span class="n">md</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;mdtraj&quot;</span><span class="p">)</span>
<span class="n">nv</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;nglview&quot;</span><span class="p">)</span>
<span class="n">mda</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;MDAnalysis&quot;</span><span class="p">)</span>
<span class="n">pd</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;pandas&quot;</span><span class="p">)</span>
<span class="n">go</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;graph_objects&quot;</span><span class="p">)</span>
<span class="n">px</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;express&quot;</span><span class="p">)</span>
<span class="n">make_subplots</span> <span class="o">=</span> <span class="n">_optional_import</span><span class="p">(</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span> <span class="s2">&quot;subplots.make_subplots&quot;</span><span class="p">)</span>


<span class="c1">################################################################################</span>
<span class="c1"># Globals</span>
<span class="c1">################################################################################</span>


<span class="n">__all__</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;distance_histogram&quot;</span><span class="p">,</span>
    <span class="s2">&quot;distance_histogram_interactive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_raw_data&quot;</span><span class="p">,</span>
    <span class="s2">&quot;interactive_path_visualization&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_ramachandran&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_dssp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_end2end&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_ball_and_stick&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_trajs_by_parameter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_free_energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;animate_lowd_trajectory&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">GLOBAL_LAYOUT</span> <span class="o">=</span> <span class="p">{}</span>


<span class="c1">################################################################################</span>
<span class="c1"># Utilities</span>
<span class="c1">################################################################################</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">get_histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">return_edges</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">get_histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">return_edges</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> <span class="o">...</span>


<span class="k">def</span> <span class="nf">get_histogram</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
    <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a 2D histogram.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): The x coordinates of the data.</span>
<span class="sd">        y (np.ndarray): The y coordinates of the data.</span>
<span class="sd">        bins (int): The number of bins passed to np.histogram2d.</span>
<span class="sd">        weights (np.ndarray): The weights passed to np.histogram2d.</span>
<span class="sd">        avoid_zero_count (bool): Avoid zero counts by lifting all</span>
<span class="sd">            histogram elements to the minimum value before computing the free</span>
<span class="sd">            energy. If False, zero histogram counts would yield infinity</span>
<span class="sd">            in the free energy.</span>
<span class="sd">        transpose (bool): Whether to transpose the output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.ndarray, np.ndarray, np.ndarray]: A tuple containing:</span>
<span class="sd">            xcenters, ycenters, and the histogram.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from encodermap.plot.plotting import get_histogram</span>
<span class="sd">        &gt;&gt;&gt; x, y = np.random.uniform(size=(2, 500))</span>
<span class="sd">        &gt;&gt;&gt; xcenters, ycenters, H = get_histogram(x, y)</span>
<span class="sd">        &gt;&gt;&gt; xcenters.shape</span>
<span class="sd">        (100,)</span>
<span class="sd">        &gt;&gt;&gt; H.shape</span>
<span class="sd">        (100, 100)</span>
<span class="sd">        &gt;&gt;&gt; np.min(H)</span>
<span class="sd">        0.0</span>
<span class="sd">        &gt;&gt;&gt; xcenters, ycenters, H = get_histogram(x, y, avoid_zero_count=True)</span>
<span class="sd">        &gt;&gt;&gt; np.min(H)</span>
<span class="sd">        1.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">xcenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ycenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">avoid_zero_count</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">H</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]))</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_edges</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">H</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">,</span> <span class="n">H</span>


<span class="k">def</span> <span class="nf">get_density</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a 2D histogram with density.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): The x coordinates of the data.</span>
<span class="sd">        y (np.ndarray): The y coordinates of the data.</span>
<span class="sd">        bins (int): The number of bins passed to np.histogram2d.</span>
<span class="sd">        weights (np.ndarray): The weights passed to np.histogram2d.</span>
<span class="sd">        avoid_zero_count (bool): Avoid zero counts by lifting all</span>
<span class="sd">            histogram elements to the minimum value before computing the free</span>
<span class="sd">            energy. If False, zero histogram counts would yield infinity</span>
<span class="sd">            in the free energy.</span>
<span class="sd">        transpose (bool): Whether to transpose the output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.ndarray, np.ndarray, np.ndarray]: A tuple containing:</span>
<span class="sd">            xcenters, ycenters, and the histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">get_histogram</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">avoid_zero_count</span><span class="p">,</span> <span class="n">transpose</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">to_density</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_density</span><span class="p">(</span><span class="n">H</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize histogram counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        H (np.ndarray): The histogram to normalize.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The normalized histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">H</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">to_free_energy</span><span class="p">(</span>
    <span class="n">H</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">kT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">minener_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute free energies from histogram counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        H (np.ndarray): The density histogram to get the free energy from.</span>
<span class="sd">        kT (float): The value of kT in the desired energy unit. By default,</span>
<span class="sd">            energies are computed in kT (setting 1.0). If you want to</span>
<span class="sd">            measure the energy in kJ/mol at 298 K, use kT=2.479 and</span>
<span class="sd">            change the cbar_label accordingly. Defaults to 1.0.</span>
<span class="sd">        minener_zero (bool): Shifts the energy minimum to zero. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The free energy values in units of kT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="n">F</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">nonzero</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">minener_zero</span><span class="p">:</span>
        <span class="n">F</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">nonzero</span><span class="p">])</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">*</span> <span class="n">kT</span>
    <span class="k">return</span> <span class="n">F</span>


<span class="k">def</span> <span class="nf">get_free_energy</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">minener_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a 2D histogram with free energy.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): The x coordinates of the data.</span>
<span class="sd">        y (np.ndarray): The y coordinates of the data.</span>
<span class="sd">        bins (int): The number of bins passed to np.histogram2d.</span>
<span class="sd">        weights (np.ndarray): The weights passed to np.histogram2d.</span>
<span class="sd">        avoid_zero_count (bool): Avoid zero counts by lifting all</span>
<span class="sd">            histogram elements to the minimum value before computing the free</span>
<span class="sd">            energy. If False, zero histogram counts would yield infinity</span>
<span class="sd">            in the free energy.</span>
<span class="sd">        kT (float): The value of kT in the desired energy unit. By default,</span>
<span class="sd">            energies are computed in kT (setting 1.0). If you want to</span>
<span class="sd">            measure the energy in kJ/mol at 298 K, use kT=2.479 and</span>
<span class="sd">            change the cbar_label accordingly. Defaults to 1.0.</span>
<span class="sd">        minener_zero (bool): Shifts the energy minimum to zero. Defaults to False.</span>
<span class="sd">        transpose (bool): Whether to transpose the output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.ndarray, np.ndarray, np.ndarray]: A tuple containing:</span>
<span class="sd">            xcenters, ycenters, and the histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">get_density</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">avoid_zero_count</span><span class="p">,</span> <span class="n">transpose</span>
    <span class="p">)</span>

    <span class="c1"># to free energy</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">to_free_energy</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">kT</span><span class="p">,</span> <span class="n">minener_zero</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">,</span> <span class="n">H</span>


<span class="k">def</span> <span class="nf">hex_to_rgba</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;rgba(</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="c1">################################################################################</span>
<span class="c1"># Private Functions</span>
<span class="c1">################################################################################</span>


<span class="c1"># @functools.cache</span>
<span class="k">def</span> <span class="nf">_get_squiggly_arrow</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.5</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">rotmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">x</span> <span class="o">-=</span> <span class="mf">1.25</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">rotmat</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
            <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">T</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
                <span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">j</span><span class="p">))</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;trajectory&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),),</span> <span class="n">fill_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">sub_df</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_project_onto_plane</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">_angle_arc</span><span class="p">(</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a `go.Scatetr3d` plot as an arc to represent he dihedral defined by `points`.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (np.ndarray): The points as a (4, )-shaped numpy array.</span>
<span class="sd">        name (str): The name of the angle arc when the mouse is hovered.</span>
<span class="sd">        value (float): The value of the dihedral in radians.</span>
<span class="sd">        radius (float): The radius of the arc. Defaults to 0.05 nm.</span>
<span class="sd">        n_points (int): The number of points used to plot this arc. More</span>
<span class="sd">            points might slow donw the system. Defaults to 100.</span>

<span class="sd">    Returns:</span>
<span class="sd">        go.Scatter3d: The plotly trace.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">a</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">face_normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">face_normal_unit</span> <span class="o">=</span> <span class="n">face_normal</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">face_normal</span><span class="p">)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">u_unit</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">u_unit</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">)</span>
    <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{meta[0]:.2f}</span><span class="s2"> deg&quot;</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">center</span>
        <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rho</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rho</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">z</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="s2">&quot;dash&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_dihedral_arc</span><span class="p">(</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">initial_points</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;select&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span>
    <span class="n">true_to_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">:</span>
    <span class="c1"># get the center</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">face_normal</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">face_normal_unit</span> <span class="o">=</span> <span class="n">face_normal</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">face_normal</span><span class="p">)</span>
    <span class="nb">sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">face_normal</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial_points</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
        <span class="c1"># first, get a random vector on the plane with normal `face_normal`</span>
        <span class="n">vertical_to_face_normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">ind_largest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ind_2nd_largest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">vertical_to_face_normal</span><span class="p">[</span><span class="n">ind_2nd_largest</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">face_normal</span><span class="p">[</span><span class="n">ind_largest</span><span class="p">]</span>
        <span class="n">vertical_to_face_normal</span><span class="p">[</span><span class="n">ind_largest</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_normal</span><span class="p">[</span><span class="n">ind_2nd_largest</span><span class="p">]</span>
        <span class="n">vertical_to_face_normal_unit</span> <span class="o">=</span> <span class="n">vertical_to_face_normal</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="n">vertical_to_face_normal</span>
        <span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">vertical_to_face_normal_unit</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">vertical_to_face_normal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

        <span class="c1"># then get the crossproduct</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">vertical_to_face_normal</span><span class="p">)</span>
        <span class="n">u_unit</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">u_unit</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{meta[0]}</span><span class="s2">&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">initial_points</span> <span class="o">==</span> <span class="s2">&quot;select&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_project_onto_plane</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">face_normal_unit</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">u_unit</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">u_unit</span>

        <span class="n">dihedral_value</span> <span class="o">=</span> <span class="n">_dihedral</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">true_to_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dihedral_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">dihedral_value</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">dihedral_value</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                <span class="n">num</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{meta[0]}</span><span class="s2"> %</span><span class="si">{meta[1]:.2f}</span><span class="s2"> deg&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">dihedral_value</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Argument `initial_points` must be &#39;random&#39; or &#39;select&#39;, not </span><span class="si">{</span><span class="n">initial_points</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">center</span>
        <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rho</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rho</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">z</span><span class="o">=</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="s2">&quot;dash&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_flatten_coords</span><span class="p">(</span><span class="n">traj</span><span class="p">:</span> <span class="s2">&quot;SingleTraj&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flattens coordinates, so it is easier to render them as images.&quot;&quot;&quot;</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="kn">from</span> <span class="nn">mdtraj.geometry.angle</span> <span class="kn">import</span> <span class="n">_angle</span>
    <span class="kn">from</span> <span class="nn">networkx</span> <span class="kn">import</span> <span class="n">connected_components</span>
    <span class="kn">from</span> <span class="nn">transformations</span> <span class="kn">import</span> <span class="n">affine_matrix_from_points</span><span class="p">,</span> <span class="n">rotation_matrix</span>

    <span class="c1"># Local Folder Imports</span>
    <span class="kn">from</span> <span class="nn">..loading.features</span> <span class="kn">import</span> <span class="n">CentralAngles</span><span class="p">,</span> <span class="n">CentralDihedrals</span><span class="p">,</span> <span class="n">SideChainDihedrals</span>
    <span class="kn">from</span> <span class="nn">..misc.rotate</span> <span class="kn">import</span> <span class="n">_get_near_and_far_networkx</span><span class="p">,</span> <span class="n">mdtraj_rotate</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CentralDihedrals</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SideChainDihedrals</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">angles</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">180</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mdtraj_rotate</span><span class="p">(</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span>
            <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># get best surface using 3d least squares</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">xyzT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">xyzR</span> <span class="o">=</span> <span class="n">xyz</span> <span class="o">-</span> <span class="n">centroid</span>
    <span class="n">xyzRT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">xyzR</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">xyzRT</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>

    <span class="c1"># project points</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">normal</span>
    <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span> <span class="o">*</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">projected_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">:</span>
        <span class="n">projected_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span> <span class="o">/</span> <span class="n">normal</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">))</span> <span class="o">*</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">projected_points</span><span class="p">)</span>

    <span class="c1"># fix distances</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edge_lengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">atoms_in_bonds_is</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">atoms_in_bonds_should_be</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
        <span class="n">atoms_in_bonds_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">atoms_in_bonds_is</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
        <span class="n">edge_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">atoms_in_bonds_is</span><span class="p">)</span> <span class="o">==</span> <span class="n">atoms_in_bonds_should_be</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Can&#39;t flatten topology: </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">. There are atoms which are not part of bonds.&quot;</span>
    <span class="n">bondgraph</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">to_bondgraph</span><span class="p">()</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">edge_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">edge_lengths</span><span class="p">)</span>
    <span class="n">near_and_far_networkx</span> <span class="o">=</span> <span class="n">_get_near_and_far_networkx</span><span class="p">(</span>
        <span class="n">bondgraph</span><span class="p">,</span>
        <span class="n">edges</span><span class="p">,</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">length_should_be</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">edges</span><span class="p">,</span> <span class="n">near_and_far_networkx</span><span class="p">,</span> <span class="n">edge_lengths</span>
    <span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">xyz</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">length_is</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">*</span> <span class="n">length_should_be</span>
        <span class="n">xyz</span><span class="p">[</span><span class="o">~</span><span class="n">indices</span><span class="p">]</span> <span class="o">+=</span> <span class="n">trans</span>

    <span class="c1"># fix angles</span>
    <span class="n">angle_should_be</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">angle_indices</span> <span class="o">=</span> <span class="n">CentralAngles</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="o">.</span><span class="n">angle_indexes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angle_indices</span><span class="p">):</span>
        <span class="n">angle_center</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">angle_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bc</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">angle_should_be</span> <span class="o">-</span> <span class="n">angle_value</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">convert_node_labels_to_integers</span><span class="p">(</span><span class="n">bondgraph</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">components</span> <span class="o">=</span> <span class="n">components</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">subgraph</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">far</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span>
            <span class="n">diff</span><span class="p">,</span>
            <span class="n">normal</span><span class="p">,</span>
            <span class="n">angle_center</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="n">xyz</span><span class="p">[</span><span class="n">far</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">xyz</span><span class="p">[</span><span class="n">far</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">padded</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">z</span><span class="o">=</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_plot_ball_and_stick</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;SingleTraj&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">],</span>
    <span class="n">frame_subsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">highlight</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;atoms&quot;</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;central_dihedrals&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;atoms&quot;</span><span class="p">,</span>
    <span class="n">atom_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_angle_arcs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">angle_arcs_true_to_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">animation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">persistent_hover</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="s2">&quot;copy&quot;</span><span class="p">):</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">SingleTraj</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">animation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Animation of ball and stick plot not yet implemented.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># data for plotting and annotation</span>
    <span class="k">if</span> <span class="n">atom_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">atom_slice</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t index </span><span class="si">{</span><span class="n">traj</span><span class="si">=}</span><span class="s2"> with </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">animation</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">frame_subsample</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">]),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Can only create a flattened representation for trajs without hydrogen. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Use the `atom_indices` argument to remove the hydrogen.&quot;</span>
        <span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">_flatten_coords</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">frame_subsample</span><span class="p">]</span>
    <span class="n">atom_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">bonds</span><span class="p">]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">24</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="o">!=</span> <span class="s2">&quot;H&quot;</span> <span class="k">else</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;bonds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;angles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;central_dihedrals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">sizes</span> <span class="o">/=</span> <span class="mf">1.3</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">number</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x: </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;y: </span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;z: </span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_names</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">atom_names</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;rgb(200, 200, 200)&quot;</span><span class="p">,</span>  <span class="c1"># hydrogen</span>
        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;rgb(80, 80, 80)&quot;</span><span class="p">,</span>  <span class="c1"># carbon</span>
        <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;rgb(0, 0, 255)&quot;</span><span class="p">,</span>  <span class="c1"># nitrogen</span>
        <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;rgb(255, 0, 0)&quot;</span><span class="p">,</span>  <span class="c1"># oxygen</span>
        <span class="mi">15</span><span class="p">:</span> <span class="s2">&quot;rgb(160, 32, 240)&quot;</span><span class="p">,</span>  <span class="c1"># phosphorus</span>
        <span class="mi">16</span><span class="p">:</span> <span class="s2">&quot;rgb(255, 255, 0)&quot;</span><span class="p">,</span>  <span class="c1"># sulfur</span>
        <span class="mi">34</span><span class="p">:</span> <span class="s2">&quot;rgb(170, 74, 68)&quot;</span><span class="p">,</span>  <span class="c1"># selenium</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">custom_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colormap</span><span class="p">:</span>
                <span class="n">color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colormap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;rgb(255, 0, 124)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">),),</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;rgb(126, 126, 126)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">custom_colors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">color</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

    <span class="c1"># for circle arcs</span>
    <span class="n">circles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># set customdata and hovertemplate</span>
    <span class="k">if</span> <span class="n">highlight</span> <span class="o">==</span> <span class="s2">&quot;atoms&quot;</span><span class="p">:</span>
        <span class="n">customdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">atom_names</span><span class="p">,</span>
                <span class="n">coords</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{customdata[0]}</span><span class="s2">:&lt;br&gt;%</span><span class="si">{customdata[1]}</span><span class="s2">&quot;</span>
        <span class="n">hoverinfo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">highlight</span> <span class="o">==</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span>
        <span class="c1"># Local Folder Imports</span>
        <span class="kn">from</span> <span class="nn">..loading.features</span> <span class="kn">import</span> <span class="n">CentralAngles</span><span class="p">,</span> <span class="n">SideChainAngles</span>

        <span class="n">x_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">z_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angle_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotations_text</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Central Angles</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">CentralAngles</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">transform</span><span class="p">()[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">x_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">y_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">z_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">angle_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Angle: </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">add_angle_arcs</span><span class="p">:</span>
                <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_angle_arc</span><span class="p">(</span>
                        <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Sidechain Angles</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">SideChainAngles</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">transform</span><span class="p">()[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">x_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">y_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">z_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">angle_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Angle: </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">add_angle_arcs</span><span class="p">:</span>
                <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">_angle_arc</span><span class="p">(</span>
                        <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">customdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hoverinfo</span> <span class="o">=</span> <span class="s2">&quot;skip&quot;</span>
        <span class="n">center_customdata</span> <span class="o">=</span> <span class="n">angle_names</span>
        <span class="n">center_hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{customdata}</span><span class="s2">&quot;</span>

    <span class="k">elif</span> <span class="n">highlight</span> <span class="o">==</span> <span class="s2">&quot;bonds&quot;</span><span class="p">:</span>
        <span class="c1"># Local Folder Imports</span>
        <span class="kn">from</span> <span class="nn">..loading.features</span> <span class="kn">import</span> <span class="n">AllBondDistances</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">AllBondDistances</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">)</span>

        <span class="n">x_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">z_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bond_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotations_text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">()):</span>
            <span class="n">x_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">])),</span>
            <span class="n">y_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="n">z_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">bond_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Bond between </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">annotations_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">customdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hoverinfo</span> <span class="o">=</span> <span class="s2">&quot;skip&quot;</span>
        <span class="n">center_customdata</span> <span class="o">=</span> <span class="n">bond_names</span>
        <span class="n">center_hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{customdata}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;central_dihedrals&quot;</span><span class="p">]:</span>
        <span class="c1"># Local Folder Imports</span>
        <span class="kn">from</span> <span class="nn">..loading.features</span> <span class="kn">import</span> <span class="n">CentralDihedrals</span><span class="p">,</span> <span class="n">SideChainDihedrals</span>

        <span class="n">x_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">z_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dihedral_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotations_text</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Central Dihedrals</span>
        <span class="k">if</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;central_dihedrals&quot;</span><span class="p">]:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">CentralDihedrals</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">()):</span>
                <span class="n">x_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">])),</span>
                <span class="n">y_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">])),</span>
                <span class="n">z_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">]))</span>
                <span class="n">dihedral_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">annotations_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">add_angle_arcs</span><span class="p">:</span>
                    <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">_dihedral_arc</span><span class="p">(</span>
                            <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">true_to_value</span><span class="o">=</span><span class="n">angle_arcs_true_to_value</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Sidechain Dihedrals</span>
        <span class="k">if</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">]:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">SideChainDihedrals</span><span class="p">(</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">()):</span>
                <span class="n">x_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">])),</span>
                <span class="n">y_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">])),</span>
                <span class="n">z_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">]))</span>
                <span class="n">dihedral_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">annotations_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">add_angle_arcs</span><span class="p">:</span>
                    <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">_dihedral_arc</span><span class="p">(</span>
                            <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">true_to_value</span><span class="o">=</span><span class="n">angle_arcs_true_to_value</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">customdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hovertemplate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hoverinfo</span> <span class="o">=</span> <span class="s2">&quot;skip&quot;</span>
        <span class="n">center_customdata</span> <span class="o">=</span> <span class="n">dihedral_names</span>
        <span class="n">center_hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{customdata}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The argument `highlight` must be one of the following: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;atoms&#39;, &#39;bonds&#39;, &#39;angles&#39;, &#39;dihedrals&#39;. You supplied </span><span class="si">{</span><span class="n">highlight</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># create scatter trace</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">z</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">customdata</span><span class="o">=</span><span class="n">customdata</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Atoms&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">hoverinfo</span><span class="o">=</span><span class="n">hoverinfo</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create line trace</span>
    <span class="n">x_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">z_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">x_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">y_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">z_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">x_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">y_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">z_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_lines</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_lines</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z_lines</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="p">(</span>
                <span class="mi">6</span>
                <span class="k">if</span> <span class="n">highlight</span>
                <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;central_dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="mi">1</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create figure</span>
    <span class="k">if</span> <span class="n">highlight</span> <span class="o">==</span> <span class="s2">&quot;atoms&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">scatter</span><span class="p">,</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_centers</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_centers</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="n">z_centers</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">highlight</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
            <span class="n">customdata</span><span class="o">=</span><span class="n">center_customdata</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">center_hovertemplate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers</span><span class="p">,</span> <span class="n">scatter</span><span class="p">,</span> <span class="n">lines</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;central_dihderals&quot;</span><span class="p">,</span> <span class="s2">&quot;side_dihedrals&quot;</span><span class="p">]:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">circles</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">persistent_hover</span><span class="p">:</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">highlight</span> <span class="o">==</span> <span class="s2">&quot;atoms&quot;</span><span class="p">:</span>
            <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                        <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_centers</span><span class="p">,</span> <span class="n">y_centers</span><span class="p">,</span> <span class="n">z_centers</span><span class="p">,</span> <span class="n">annotations_text</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
                <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
                        <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">scene</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;xaxis_gridcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(102, 102, 102)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yaxis_gridcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(102, 102, 102)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zaxis_gridcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(102, 102, 102)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="n">annotations</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;scene&quot;</span> <span class="ow">in</span> <span class="n">GLOBAL_LAYOUT</span><span class="p">:</span>
        <span class="n">scene</span> <span class="o">|=</span> <span class="n">GLOBAL_LAYOUT</span><span class="p">[</span><span class="s2">&quot;scene&quot;</span><span class="p">]</span>
        <span class="n">global_layout</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">GLOBAL_LAYOUT</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;scene&quot;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">global_layout</span> <span class="o">=</span> <span class="n">GLOBAL_LAYOUT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">global_layout</span><span class="p">,</span>
        <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create frames</span>
    <span class="k">if</span> <span class="n">animation</span><span class="p">:</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">scatter</span><span class="p">,</span> <span class="n">lines</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">:</span>
            <span class="n">x_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">y_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">z_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">x_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">y_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">z_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">x_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">y_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">z_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="n">customdata</span><span class="o">=</span><span class="n">atom_names</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                        <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;%</span><span class="si">{customdata}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                            <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x_lines</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">y_lines</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">z_lines</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">updatemenus</span><span class="o">=</span><span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span>
                    <span class="n">buttons</span><span class="o">=</span><span class="p">[</span>
                        <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Play&quot;</span><span class="p">,</span>
                            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;animate&quot;</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                                <span class="kc">None</span><span class="p">,</span>
                                <span class="nb">dict</span><span class="p">(</span>
                                    <span class="n">frame</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                        <span class="n">redraw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fromcurrent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;immediate&quot;</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="c1"># sliders=(</span>
            <span class="c1">#     [</span>
            <span class="c1">#         {</span>
            <span class="c1">#             &quot;steps&quot;: [</span>
            <span class="c1">#                 {</span>
            <span class="c1">#                     &quot;args&quot;: [</span>
            <span class="c1">#                         [f.name],</span>
            <span class="c1">#                         {</span>
            <span class="c1">#                             &quot;frame&quot;: {&quot;duration&quot;: 0, &quot;redraw&quot;: True},</span>
            <span class="c1">#                             &quot;mode&quot;: &quot;immediate&quot;,</span>
            <span class="c1">#                         },</span>
            <span class="c1">#                     ],</span>
            <span class="c1">#                     &quot;label&quot;: f.name,</span>
            <span class="c1">#                     &quot;method&quot;: &quot;animate&quot;,</span>
            <span class="c1">#                 }</span>
            <span class="c1">#                 for f in frames</span>
            <span class="c1">#             ],</span>
            <span class="c1">#         }</span>
            <span class="c1">#     ],</span>
            <span class="c1"># ),</span>
            <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])]),</span>
                <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]),</span>
                <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">])]),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="c1">################################################################################</span>
<span class="c1"># Plotting Functions</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="animate_lowd_trajectory">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.animate_lowd_trajectory">[docs]</a>
<span class="k">def</span> <span class="nf">animate_lowd_trajectory</span><span class="p">(</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">potential</span><span class="p">:</span>
        <span class="n">p_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="o">-</span> <span class="mf">0.025</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
            <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="n">v_init</span>
            <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
            <span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">animation_frame</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
            <span class="n">range_x</span><span class="o">=</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span>
            <span class="n">range_y</span><span class="o">=</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">updatemenus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;transition&quot;</span><span class="p">][</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">potential</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">_get_squiggly_arrow</span><span class="p">(</span><span class="n">n_frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                    <span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                    <span class="n">animation_frame</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
                    <span class="n">range_x</span><span class="o">=</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span>
                    <span class="n">range_y</span><span class="o">=</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">updatemenus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;transition&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;duration&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">_get_squiggly_arrow</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
                    <span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                    <span class="n">animation_frame</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;trajectory&quot;</span><span class="p">,</span>
                    <span class="n">range_x</span><span class="o">=</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span>
                    <span class="n">range_y</span><span class="o">=</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span>
                    <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">updatemenus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;transition&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;duration&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_trajs_by_parameter">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_trajs_by_parameter">[docs]</a>
<span class="k">def</span> <span class="nf">plot_trajs_by_parameter</span><span class="p">(</span>
    <span class="n">trajs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SingleTraj</span><span class="p">,</span> <span class="n">TrajEnsemble</span><span class="p">],</span>
    <span class="n">parameter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;common_str&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frame&quot;</span><span class="p">,</span>
            <span class="s2">&quot;encoded_frame&quot;</span><span class="p">,</span>
            <span class="s2">&quot;traj_num&quot;</span><span class="p">,</span>
            <span class="s2">&quot;topology&quot;</span><span class="p">,</span>
            <span class="s2">&quot;free_energy&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="nb">str</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;common_str&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">contourtype</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;contour&quot;</span><span class="p">,</span> <span class="s2">&quot;contourf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;countour&quot;</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lowd&quot;</span><span class="p">,</span>
    <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">z_name_overwrite</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must provide either x and y or both None.&quot;</span>
        <span class="k">assert</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">_CVs</span><span class="p">,</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The CV `col`=</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> cannot be found in the `trajs` with CVs: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. Please use `load_CVs` to load the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;low-dimensional coordinates for the `trajs`.&quot;</span>
        <span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">25_000</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
        <span class="s2">&quot;ENCODERMAP_SKIP_SCATTER_SIZE_CHECK&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span>
    <span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The number of points is very large (</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">). Using scatter &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;with this number of points might crash your browser and maybe &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;even your system. Set the environment variable &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;ENCODERMAP_SKIP_SCATTER_SIZE_CHECK&#39; to &#39;True&#39; to skip this check&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;common_str&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">traj</span><span class="o">.</span><span class="n">common_str</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;free_energy&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">_plot_free_energy</span><span class="p">(</span><span class="o">*</span><span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">)],</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Free Energy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xaxis_title&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;yaxis_title&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;encoded_frame&quot;</span><span class="p">:</span>
        <span class="c1"># Encodermap imports</span>
        <span class="kn">from</span> <span class="nn">encodermap.loading.features</span> <span class="kn">import</span> <span class="n">pair</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pair</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">traj_num</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;traj_num&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">traj</span><span class="o">.</span><span class="n">traj_num</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_</span> <span class="o">:=</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">parameter</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">_</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Argument `parameter` must be one of &#39;common_str&#39;, &#39;frame&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;encoded_frame&#39;, &#39;traj_num&#39;, &#39;topology&#39;, &#39;free_energy&#39;, or any &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;of the `TrajEnsemble` 1-dimensional CVs.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;You provided </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># this is the same no matter what datasource we use</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">z_name_overwrite</span><span class="p">:</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">z_name_overwrite</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for Trajectories with </span><span class="si">{</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_frames</span><span class="si">}</span><span class="s2"> frames, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trajs</span><span class="o">.</span><span class="n">n_trajs</span><span class="si">}</span><span class="s2"> trajs and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">top</span><span class="p">)</span><span class="si">}</span><span class="s2"> uniques topologies.&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
            <span class="n">render_mode</span><span class="o">=</span><span class="s2">&quot;webgl&quot;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;x in a.u.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;y in a.u.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">parameter</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">opacity</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cbar</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="n">GLOBAL_LAYOUT</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Alphabet</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Plotly</span>

        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span> <span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span> <span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">xcenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ycenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">datapoint</span><span class="p">,</span> <span class="n">sub_df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">H</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="o">*</span><span class="n">sub_df</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Contour</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">xcenters</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">ycenters</span><span class="p">,</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">contours_type</span><span class="o">=</span><span class="s2">&quot;constraint&quot;</span><span class="p">,</span>
                    <span class="n">contours_operation</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
                    <span class="n">contours_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">contours_coloring</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">hex_to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">),</span>
                    <span class="n">line_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">datapoint</span><span class="p">,</span>
                    <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># if contourtype == &quot;contourf&quot;:</span>
            <span class="c1">#     H = H.astype(bool).astype(float)</span>
            <span class="c1">#     H[H == 0] = np.nan</span>
            <span class="c1">#     traces.append(</span>
            <span class="c1">#         go.Contour(</span>
            <span class="c1">#             x=xcenters,</span>
            <span class="c1">#             y=ycenters,</span>
            <span class="c1">#             z=H.T,</span>
            <span class="c1">#             colorscale=[[0, hex_to_rgba(color, alpha=alpha)], [1, &quot;rgba(0, 0, 0, 0)&quot;]],</span>
            <span class="c1">#             showscale=False,</span>
            <span class="c1">#         ),</span>
            <span class="c1">#     )</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;autosize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="n">GLOBAL_LAYOUT</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Argument `type` must be either &#39;scatter&#39; or &#39;heatmap&#39;. You provided </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span> <span class="nf">_plot_free_energy</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">minener_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cbar_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;free energy / kT&quot;</span><span class="p">,</span>
    <span class="n">colorbar_x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots free energy using plotly.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): The x coordinates of the data.</span>
<span class="sd">        y (np.ndarray): The y coordinates of the data.</span>
<span class="sd">        bins (int): The number of bins passed to np.histogram2d.</span>
<span class="sd">        weights (np.ndarray): The weights passed to np.histogram2d.</span>
<span class="sd">        avoid_zero_count (bool): Avoid zero counts by lifting all</span>
<span class="sd">            histogram elements to the minimum value before computing the free</span>
<span class="sd">            energy. If False, zero histogram counts would yield infinity</span>
<span class="sd">            in the free energy.</span>
<span class="sd">        kT (float): The value of kT in the desired energy unit. By default,</span>
<span class="sd">            energies are computed in kT (setting 1.0). If you want to</span>
<span class="sd">            measure the energy in kJ/mol at 298 K, use kT=2.479 and</span>
<span class="sd">            change the cbar_label accordingly. Defaults to 1.0.</span>
<span class="sd">        minener_zero (bool): Shifts the energy minimum to zero. Defaults to False.</span>
<span class="sd">        transpose (bool): Whether to transpose the output.</span>
<span class="sd">        cbar (bool): Whether to display a colorbar. Dewfaults to False.</span>
<span class="sd">        cbar_label (str): The label of the colorbar. Defaults to &#39;free energy / kT&#39;.</span>
<span class="sd">        colorbar_x (Optional[float]): Sets the x position with respect to xref</span>
<span class="sd">            of the color bar (in plot fraction). When xref is “paper”, None becomes</span>
<span class="sd">            1.02 when orientation is “v” and 0.5 when orientation is “h”. When</span>
<span class="sd">            xref is “container”, None becaomses 1 when orientation is “v” and</span>
<span class="sd">            0.5 when orientation is “h”. Must be between</span>
<span class="sd">            0 and 1 if xref is “container” and between “-2” and 3 if xref is</span>
<span class="sd">            “paper”.</span>

<span class="sd">    Returns:</span>
<span class="sd">        go.Contour: The contour plot.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import plotly.graph_objects as go</span>
<span class="sd">        &gt;&gt;&gt; from encodermap.plot.plotting import _plot_free_energy</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; x, y = np.random.normal(size=(2, 1000))</span>
<span class="sd">        &gt;&gt;&gt; trace = _plot_free_energy(x, y, bins=10)</span>
<span class="sd">        &gt;&gt;&gt; fig = go.Figure(data=[trace])</span>
<span class="sd">        &gt;&gt;&gt; np.any(fig.data[0].z == float(&quot;inf&quot;))</span>
<span class="sd">        True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">get_free_energy</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">kT</span><span class="o">=</span><span class="n">kT</span><span class="p">,</span>
        <span class="n">avoid_zero_count</span><span class="o">=</span><span class="n">avoid_zero_count</span><span class="p">,</span>
        <span class="n">minener_zero</span><span class="o">=</span><span class="n">minener_zero</span><span class="p">,</span>
        <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Contour</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span>
        <span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Lowd projection&quot;</span><span class="p">,</span>
        <span class="n">showscale</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span>
        <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
        <span class="n">colorbar_title</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span>
        <span class="c1"># histfunc=&quot;count&quot;,</span>
        <span class="n">colorbar_x</span><span class="o">=</span><span class="n">colorbar_x</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">trace</span>


<div class="viewcode-block" id="plot_free_energy">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_free_energy">[docs]</a>
<span class="k">def</span> <span class="nf">plot_free_energy</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">avoid_zero_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">minener_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">transpose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cbar_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;free energy / kT&quot;</span><span class="p">,</span>
    <span class="n">colorbar_x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots free energy using plotly.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.ndarray): The x coordinates of the data.</span>
<span class="sd">        y (np.ndarray): The y coordinates of the data.</span>
<span class="sd">        bins (int): The number of bins passed to np.histogram2d.</span>
<span class="sd">        weights (np.ndarray): The weights passed to np.histogram2d.</span>
<span class="sd">        avoid_zero_count (bool): Avoid zero counts by lifting all</span>
<span class="sd">            histogram elements to the minimum value before computing the free</span>
<span class="sd">            energy. If False, zero histogram counts would yield infinity</span>
<span class="sd">            in the free energy.</span>
<span class="sd">        kT (float): The value of kT in the desired energy unit. By default,</span>
<span class="sd">            energies are computed in kT (setting 1.0). If you want to</span>
<span class="sd">            measure the energy in kJ/mol at 298 K, use kT=2.479 and</span>
<span class="sd">            change the cbar_label accordingly. Defaults to 1.0.</span>
<span class="sd">        minener_zero (bool): Shifts the energy minimum to zero. Defaults to False.</span>
<span class="sd">        transpose (bool): Whether to transpose the output.</span>
<span class="sd">        cbar (bool): Whether to display a colorbar. Dewfaults to False.</span>
<span class="sd">        cbar_label (str): The label of the colorbar. Defaults to &#39;free energy / kT&#39;.</span>
<span class="sd">        colorbar_x (Optional[float]): Sets the x position with respect to xref</span>
<span class="sd">            of the color bar (in plot fraction). When xref is “paper”, None becomes</span>
<span class="sd">            1.02 when orientation is “v” and 0.5 when orientation is “h”. When</span>
<span class="sd">            xref is “container”, None becaomses 1 when orientation is “v” and</span>
<span class="sd">            0.5 when orientation is “h”. Must be between</span>
<span class="sd">            0 and 1 if xref is “container” and between “-2” and 3 if xref is</span>
<span class="sd">            “paper”.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">_plot_free_energy</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                <span class="n">kT</span><span class="o">=</span><span class="n">kT</span><span class="p">,</span>
                <span class="n">avoid_zero_count</span><span class="o">=</span><span class="n">avoid_zero_count</span><span class="p">,</span>
                <span class="n">minener_zero</span><span class="o">=</span><span class="n">minener_zero</span><span class="p">,</span>
                <span class="n">transpose</span><span class="o">=</span><span class="n">transpose</span><span class="p">,</span>
                <span class="n">cbar</span><span class="o">=</span><span class="n">cbar</span><span class="p">,</span>
                <span class="n">cbar_label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">,</span>
                <span class="n">colorbar_x</span><span class="o">=</span><span class="n">colorbar_x</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="o">|</span> <span class="n">GLOBAL_LAYOUT</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="interactive_path_visualization">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.interactive_path_visualization">[docs]</a>
<span class="k">def</span> <span class="nf">interactive_path_visualization</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">SingleTraj</span><span class="p">,</span>
    <span class="n">lowd</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">widgets</span><span class="o">.</span><span class="n">GridBox</span><span class="p">:</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">path</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Path has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2"> points, Trajectory has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span><span class="si">}</span><span class="s2"> frames.&quot;</span>

    <span class="c1"># define the traces</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lowd</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">lowd</span> <span class="o">=</span> <span class="n">lowd</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">trace1</span> <span class="o">=</span> <span class="n">_plot_free_energy</span><span class="p">(</span><span class="o">*</span><span class="n">lowd</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace2</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">path</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">trace3</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Current path pos.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create a figure widget</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">trace1</span><span class="p">,</span> <span class="n">trace2</span><span class="p">,</span> <span class="n">trace3</span><span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                <span class="s2">&quot;showlegend&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># create the nglview widget</span>
    <span class="n">nglview</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">traj</span><span class="p">)</span>

    <span class="c1"># create the media slider</span>
    <span class="n">media_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Play</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
        <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">media_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">widgets</span><span class="o">.</span><span class="n">jslink</span><span class="p">((</span><span class="n">media_widget</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">media_slider</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">))</span>

    <span class="n">box1</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">g</span><span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">grid_area</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">style</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">box2</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">nglview</span><span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">grid_area</span><span class="o">=</span><span class="s2">&quot;sidebar&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">style</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">box3</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">media_widget</span><span class="p">,</span> <span class="n">media_slider</span><span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">grid_area</span><span class="o">=</span><span class="s2">&quot;footer&quot;</span><span class="p">,</span>
            <span class="n">align_content</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">style</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span>
            <span class="n">margin</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;0 0 0 0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">container</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">GridBox</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span>
            <span class="n">box1</span><span class="p">,</span>
            <span class="n">box2</span><span class="p">,</span>
            <span class="n">box3</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">,</span>
            <span class="n">grid_template_columns</span><span class="o">=</span><span class="s2">&quot;auto auto&quot;</span><span class="p">,</span>
            <span class="n">grid_template_rows</span><span class="o">=</span><span class="s2">&quot;1000 px&quot;</span><span class="p">,</span>
            <span class="n">grid_gap</span><span class="o">=</span><span class="s2">&quot;5px&quot;</span><span class="p">,</span>
            <span class="n">grid_template_areas</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &quot;main sidebar sidebar sidebar&quot;</span>
<span class="s2">            &quot;footer footer footer footer&quot;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">advance_path</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">nglview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

    <span class="n">media_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">advance_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">container</span></div>



<div class="viewcode-block" id="distance_histogram_interactive">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.distance_histogram_interactive">[docs]</a>
<span class="k">def</span> <span class="nf">distance_histogram_interactive</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">periodicity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">low_d_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">n_values</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">initial_guess</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">renderer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;colab&quot;</span><span class="p">,</span> <span class="s2">&quot;plotly_mimetype+notebook&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;AnyParameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interactive version of `distance_histogram`.</span>

<span class="sd">    Note:</span>

<span class="sd">    Args:</span>
<span class="sd">        data (np.ndarray): 2-dimensional numpy array. Columns should iterate</span>
<span class="sd">            over the dimensions of the datapoints, i.e. the dimensionality</span>
<span class="sd">            of the data. The rows should iterate over datapoints.</span>
<span class="sd">        periodicity (float): Periodicity of the data. Use `float(&quot;inf&quot;)`</span>
<span class="sd">            for non-periodic data.</span>
<span class="sd">        low_d_max (float): Upper limit for plotting the low_d sigmoid.</span>
<span class="sd">            Defaults to 5.0.</span>
<span class="sd">        n_values (int): The number of x-values to use for the  plotting</span>
<span class="sd">            of the sigmoid functions. Used in `np.linspace(min, max, n_values)`.</span>
<span class="sd">            Defaults to 1000.</span>
<span class="sd">        bins (Union[Literal[&quot;auto&quot;], int]): Number of bins for histogram.</span>
<span class="sd">            Use &#39;auto&#39; to let numpy decide how many bins to use. Defaults to &#39;auto&#39;.</span>
<span class="sd">        initial_guess (Optional[tuple[float, ...]]): Tuple of sketchmap</span>
<span class="sd">            sigmoid parameters n shape (highd_sigma, highd_a, highd_b,</span>
<span class="sd">            lowd_sigma, lowd_a, lowd_b). If None is provided, the default</span>
<span class="sd">            values: (4.5, 12, 6, 1, 2, 6) are chosen. Defaults to None.</span>
<span class="sd">        parameters (AnyParameters): An instance of `encodermap.Parameters`, or</span>
<span class="sd">            `encodermap.ADCParameters`, to which the sigmoid parameters will be</span>
<span class="sd">            set.</span>
<span class="sd">        skip_data_size_check (bool): Whether to skip a check, that prevents the</span>
<span class="sd">            kernel to be killed when large datasets are passed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># decide the renderer</span>
    <span class="k">if</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Third Party Imports</span>
            <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">data_table</span>

            <span class="n">renderer</span> <span class="o">=</span> <span class="s2">&quot;colab&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="s2">&quot;plotly_mimetype+notebook&quot;</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="s2">&quot;You provided some nans.&quot;</span>

    <span class="c1"># some helper functions</span>
    <span class="k">def</span> <span class="nf">my_ceil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">precision</span><span class="p">),</span> <span class="n">precision</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_connection_traces</span><span class="p">(</span><span class="n">highd</span><span class="p">,</span> <span class="n">lowd</span><span class="p">,</span> <span class="n">lowd_max</span><span class="p">,</span> <span class="n">highd_max</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">highd</span><span class="p">,</span> <span class="n">lowd</span><span class="p">)):</span>
            <span class="n">l_plot</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">lowd_max</span>
            <span class="n">h_plot</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">highd_max</span>
            <span class="k">yield</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">l_plot</span><span class="p">,</span> <span class="n">h_plot</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;connection_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">line_width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> in highd maps to </span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> in lowd </span><span class="si">{</span><span class="n">lowd_max</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># get the distances while accounting for periodicity</span>
    <span class="n">vecs</span> <span class="o">=</span> <span class="n">periodic_distance_np</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">periodicity</span>
    <span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AxisError</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">high_d_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

    <span class="c1"># use the initial guess or default values</span>
    <span class="k">if</span> <span class="n">initial_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="c1"># instantiate the sliders</span>
    <span class="n">lowd_sigma_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">my_ceil</span><span class="p">(</span><span class="n">low_d_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;lowd sigma&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lowd_a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;lowd a&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lowd_b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;lowd b&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">highd_sigma_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="n">my_ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;highd sigma&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">highd_a_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;highd a&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">highd_b_slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;highd b&quot;</span><span class="p">,</span>
        <span class="n">continuous_udpate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># histogram</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># highd sigmoid</span>
    <span class="n">x_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span> <span class="n">n_values</span><span class="p">)</span>
    <span class="n">highd_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">highd_sigma_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">highd_a_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">highd_b_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">y_h</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_h</span><span class="p">,</span> <span class="o">**</span><span class="n">highd_data</span><span class="p">)</span>

    <span class="c1"># diff and norm</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
    <span class="n">dy_norm</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>

    <span class="c1"># lowd sigmoid</span>
    <span class="n">x_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_d_max</span><span class="p">,</span> <span class="n">n_values</span><span class="p">)</span>
    <span class="n">lowd_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">lowd_sigma_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">lowd_a_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">lowd_b_slider</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">y_l</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_l</span><span class="p">,</span> <span class="o">**</span><span class="n">lowd_data</span><span class="p">)</span>
    <span class="n">edges_sig</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="o">**</span><span class="n">highd_data</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">edges_sig</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y_l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">edges_l</span> <span class="o">=</span> <span class="n">x_l</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># initial subplot with two traces</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;highd&quot;</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">,</span> <span class="s2">&quot;lowd&quot;</span><span class="p">])</span>

    <span class="c1"># add the bar</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">centers</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">H</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;highd dists&quot;</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span>
            <span class="n">marker_color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">marker_opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># add the lowd sigmoid</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_l</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_l</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lowd sigmoid&quot;</span><span class="p">,</span>
            <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># add the title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Interact with the plot to select sigmoid parameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;middle&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c1"># hovermode=&quot;x&quot;,</span>
    <span class="p">)</span>

    <span class="c1"># add the highd sigmoids to a second axis</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_h</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_h</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
            <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;x4&quot;</span><span class="p">,</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;y4&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_h</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">dy_norm</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;diff sigmoid&quot;</span><span class="p">,</span>
            <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="s2">&quot;x4&quot;</span><span class="p">,</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="s2">&quot;y4&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># some adjustmentns for xaxis3</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis1</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;highd distance&quot;</span><span class="p">,</span>
            <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># xaxis2=dict(</span>
        <span class="c1">#     showticklabels=False,</span>
        <span class="c1"># ),</span>
        <span class="n">xaxis3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;lowd distance&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">yaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># make the figure responsive</span>
    <span class="c1"># add connections lines</span>
    <span class="n">trace_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_lowd_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_l</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_highd_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_h</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">get_connection_traces</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">edges_l</span><span class="p">,</span> <span class="n">_lowd_max</span><span class="p">,</span> <span class="n">_highd_max</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trace_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># create a figure widget</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">lowd_sigmoid_trace_index</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lowd sigmoid&quot;</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">highd_sigmoid_trace_index</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">diff_sigmoid_trace_index</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;diff sigmoid&quot;</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trace_names</span><span class="p">))</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">object_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;lowd sigma&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">lowd_sigmoid_trace_index</span><span class="p">],</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;sigma&quot;</span><span class="p">},</span>
        <span class="s2">&quot;lowd a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">lowd_sigmoid_trace_index</span><span class="p">],</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">},</span>
        <span class="s2">&quot;lowd b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">lowd_sigmoid_trace_index</span><span class="p">],</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">},</span>
        <span class="s2">&quot;highd sigma&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">highd_sigmoid_trace_index</span><span class="p">,</span> <span class="n">diff_sigmoid_trace_index</span><span class="p">],</span>
            <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;sigma&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;highd a&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">highd_sigmoid_trace_index</span><span class="p">,</span> <span class="n">diff_sigmoid_trace_index</span><span class="p">],</span>
            <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;highd b&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;update_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">highd_sigmoid_trace_index</span><span class="p">,</span> <span class="n">diff_sigmoid_trace_index</span><span class="p">],</span>
            <span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># define the response function</span>
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">highd_data</span>
        <span class="k">nonlocal</span> <span class="n">lowd_data</span>
        <span class="k">nonlocal</span> <span class="n">edges</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">object_mapping</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;update_data&quot;</span><span class="p">]</span>
        <span class="n">kwarg</span> <span class="o">=</span> <span class="n">object_mapping</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;keyword&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;highd&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">highd_data</span> <span class="o">|=</span> <span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lowd_data</span> <span class="o">|=</span> <span class="p">{</span><span class="n">kwarg</span><span class="p">:</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;new&quot;</span><span class="p">]}</span>
        <span class="n">y_h</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_h</span><span class="p">,</span> <span class="o">**</span><span class="n">highd_data</span><span class="p">)</span>
        <span class="n">y_l</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x_l</span><span class="p">,</span> <span class="o">**</span><span class="n">lowd_data</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y_h</span><span class="p">)</span>
        <span class="n">dy_norm</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">edges_sig</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="o">**</span><span class="n">highd_data</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">edges_sig</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y_l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_edges_l</span> <span class="o">=</span> <span class="n">x_l</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># update the parameters</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;cartesian_dist_sig_parameters&quot;</span><span class="p">):</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="s2">&quot;cartesian_dist_sig_parameters&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="s2">&quot;dist_sig_parameters&quot;</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">highd_data</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
                <span class="n">highd_data</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
                <span class="n">highd_data</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
                <span class="n">lowd_data</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">],</span>
                <span class="n">lowd_data</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
                <span class="n">lowd_data</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

        <span class="c1"># update the fig</span>
        <span class="k">with</span> <span class="n">g</span><span class="o">.</span><span class="n">batch_update</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">highd_sigmoid_trace_index</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_h</span>
            <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">diff_sigmoid_trace_index</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">dy_norm</span>
            <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lowd_sigmoid_trace_index</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y_l</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">trace_names</span><span class="p">,</span> <span class="n">new_edges_l</span><span class="p">,</span> <span class="n">edges</span><span class="p">)):</span>
                <span class="c1"># if i % 10 == 0:</span>
                <span class="n">l_plot</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">_lowd_max</span>
                <span class="n">h_plot</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">_highd_max</span>
                <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">l_plot</span><span class="p">,</span> <span class="n">h_plot</span><span class="p">]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">hovertemplate</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> in highd maps to </span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> in lowd&quot;</span>

    <span class="c1"># observe the widgets</span>
    <span class="n">lowd_sigma_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">lowd_a_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">lowd_b_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">highd_sigma_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">highd_a_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">highd_b_slider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

    <span class="c1"># create containers</span>
    <span class="n">lowd_container</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">lowd_sigma_slider</span><span class="p">,</span> <span class="n">lowd_a_slider</span><span class="p">,</span> <span class="n">lowd_b_slider</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">highd_container</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">highd_sigma_slider</span><span class="p">,</span> <span class="n">highd_a_slider</span><span class="p">,</span> <span class="n">highd_b_slider</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># start the app</span>
    <span class="k">return</span> <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">lowd_container</span><span class="p">,</span> <span class="n">highd_container</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span></div>



<div class="viewcode-block" id="distance_histogram">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.distance_histogram">[docs]</a>
<span class="k">def</span> <span class="nf">distance_histogram</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">periodicity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sigmoid_parameters</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">axes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">low_d_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">bins</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the histogram of all pairwise distances in the data.</span>

<span class="sd">    It also shows the sigmoid function and its normalized derivative.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (np.ndarray): 2-dimensional numpy array. Columns should iterate</span>
<span class="sd">            over the dimensions of the datapoints, i.e. the dimensionality</span>
<span class="sd">            of the data. The rows should iterate over datapoints.</span>
<span class="sd">        periodicity (float): Periodicity of the data. Use float(&quot;inf&quot;)</span>
<span class="sd">            for non-periodic data.</span>
<span class="sd">        sigmoid_parameters (tuple): Tuple of sketchmap sigmoid parameters</span>
<span class="sd">            in shape (Sigma, A, B, sigma, a, b).</span>
<span class="sd">        axes (Union[np.ndarray, None], optional): A numpy array of two</span>
<span class="sd">            matplotlib.axes objects or None. If None is provided, the axes will</span>
<span class="sd">            be created. Defaults to None.</span>
<span class="sd">        low_d_max (int, optional): Upper limit for plotting the low_d sigmoid.</span>
<span class="sd">            Defaults to 5.</span>
<span class="sd">        bins (Union[str, int], optional): Number of bins for histogram.</span>
<span class="sd">            Use &#39;auto&#39; to let matplotlib decide how many bins to use. Defaults to &#39;auto&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the following:</span>
<span class="sd">            - plt.axes: A matplotlib.pyplot axis used to plot the high-d distance</span>
<span class="sd">                sigmoid.</span>
<span class="sd">            - plt.axes: A matplotlib.pyplot axis used to plot the high-d distance</span>
<span class="sd">                histogram (a twinx of the first axis).</span>
<span class="sd">            - plt.axes: A matplotlib.pyplot axis used to plot the lowd sigmoid.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vecs</span> <span class="o">=</span> <span class="n">periodic_distance_np</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">periodicity</span>
    <span class="p">)</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">AxisError</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axe2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">axe2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">dists</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
    <span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">sigmoid_parameters</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">edges_sig</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="o">*</span><span class="n">sigmoid_parameters</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dy_norm</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dy_norm</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diff sigmoid&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="n">axe2</span><span class="o">.</span><span class="n">get_zorder</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;high-d&quot;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">low_d_max</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">sigmoid_parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">dy_norm</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">edges_sig</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">edges_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;low-d&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">edges_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edges_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">edges_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span>
                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axe2</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>



<div class="viewcode-block" id="plot_raw_data">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_raw_data">[docs]</a>
<span class="k">def</span> <span class="nf">plot_raw_data</span><span class="p">(</span>
    <span class="n">xyz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;SingleTraj&quot;</span><span class="p">],</span>
    <span class="n">frame_slice</span><span class="p">:</span> <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">atom_slice</span><span class="p">:</span> <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the raw data of a trajectory as xyz slices in a 3D plot.</span>

<span class="sd">    Conventions:</span>
<span class="sd">        * x: The cartesian coordinates.</span>
<span class="sd">        * y: The atom.</span>
<span class="sd">        * z: The frame.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (Union[np.ndarray], &quot;SingleTraj&quot;]): Can be either a numpy array with</span>
<span class="sd">            shape (n_frames, n_atoms, 3) or a SingleTraj object.</span>
<span class="sd">        frame_slice (slice): A slice to select the frames you want.</span>
<span class="sd">        atom_slice (slice): A slice to select the atoms you want.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">frame_extend</span><span class="p">,</span> <span class="n">atom_extend</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">atoms_ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">))[</span><span class="n">atom_slice</span><span class="p">]:</span>
            <span class="n">atoms_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">frame_extend</span><span class="p">,</span> <span class="n">atom_extend</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">atoms_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">atom_extend</span><span class="p">)[</span><span class="n">atom_slice</span><span class="p">]</span>
    <span class="n">frames_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">frame_extend</span><span class="p">)[</span><span class="n">frame_slice</span><span class="p">]</span>

    <span class="c1"># create the surfaces</span>
    <span class="n">surfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="n">cmax</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">xyz_slice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frames_ind</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">frame_slice</span><span class="p">,</span> <span class="n">atom_slice</span><span class="p">]):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms_ind</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">cmin</span><span class="p">,</span> <span class="n">xyz_slice</span><span class="o">.</span><span class="n">min</span><span class="p">()])</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">cmax</span><span class="p">,</span> <span class="n">xyz_slice</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">customdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">xyz_slice</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">frame</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">atoms_ind</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms_ind</span><span class="p">),</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">xyz_slice</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Cartesian coordinate %</span><span class="si">{customdata[2]}</span><span class="s2">&lt;br&gt;of atom %</span><span class="si">{customdata[1]}</span><span class="s2">&lt;br&gt;at &quot;</span>
            <span class="s2">&quot;frame %{customdata[0]:.d}: %</span><span class="si">{customdata[3]:.3f}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                <span class="n">surfacecolor</span><span class="o">=</span><span class="n">xyz_slice</span><span class="p">,</span>
                <span class="n">customdata</span><span class="o">=</span><span class="n">customdata</span><span class="p">,</span>
                <span class="n">coloraxis</span><span class="o">=</span><span class="s2">&quot;coloraxis&quot;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># create the figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">surfaces</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Raw data plot&quot;</span><span class="p">,</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Atom&quot;</span><span class="p">,</span>
            <span class="n">zaxis_title</span><span class="o">=</span><span class="s2">&quot;Frame no.&quot;</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms_ind</span><span class="p">)),</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="n">atoms_ind</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="n">frames_ind</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="n">frames_ind</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;Cartesian coordinate value&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">coloraxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
            <span class="n">colorbar_thickness</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
            <span class="n">colorbar_len</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span>
            <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">coloraxis_colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;value of coordinate&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="plot_ball_and_stick">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_ball_and_stick">[docs]</a>
<span class="k">def</span> <span class="nf">plot_ball_and_stick</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="s2">&quot;SingleTraj&quot;</span><span class="p">,</span>
    <span class="n">frame_subsample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">highlight</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;dihedrals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;atoms&quot;</span><span class="p">,</span>
    <span class="n">atom_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">add_angle_arcs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">animation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">persistent_hover</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">_plot_ball_and_stick</span><span class="p">(</span>
        <span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span>
        <span class="n">frame_subsample</span><span class="o">=</span><span class="n">frame_subsample</span><span class="p">,</span>
        <span class="n">highlight</span><span class="o">=</span><span class="n">highlight</span><span class="p">,</span>
        <span class="n">atom_indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span>
        <span class="n">custom_colors</span><span class="o">=</span><span class="n">custom_colors</span><span class="p">,</span>
        <span class="n">add_angle_arcs</span><span class="o">=</span><span class="n">add_angle_arcs</span><span class="p">,</span>
        <span class="n">animation</span><span class="o">=</span><span class="n">animation</span><span class="p">,</span>
        <span class="n">persistent_hover</span><span class="o">=</span><span class="n">persistent_hover</span><span class="p">,</span>
        <span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_ramachandran">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_ramachandran">[docs]</a>
<span class="k">def</span> <span class="nf">plot_ramachandran</span><span class="p">(</span>
    <span class="n">angles</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="s2">&quot;SingleTraj&quot;</span><span class="p">],</span>
    <span class="n">subsample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a Ramachandran plot using plotly.</span>

<span class="sd">    Args:</span>
<span class="sd">        angles (Union[tuple[np.ndarray, np.ndarray], np.ndarray, &quot;SingleTraj&quot;]):</span>
<span class="sd">            Either a tuple of np.ndarray in which case it is assumed that the</span>
<span class="sd">            arrays are ordered like (psi, phi). Or an array of shape</span>
<span class="sd">            (2, n_frames, n_angles), in which case it is unpacked into psi and</span>
<span class="sd">            phi angles.</span>
<span class="sd">        subsample (Optional[Union[int, slice, np.ndarray]]): Any way to subsample</span>
<span class="sd">            the data along the time-axis. Can be int (one frame), slice (more frames,</span>
<span class="sd">            defined by start, stop, step) or np.ndarray (more frames defined by</span>
<span class="sd">            their integer index).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">psi</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">angles</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">angles</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">psi</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">angles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">angles</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SingleTraj&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;central_dihedrals&quot;</span> <span class="ow">in</span> <span class="n">angles</span><span class="o">.</span><span class="n">_CVs</span><span class="p">:</span>
            <span class="n">angles</span><span class="o">.</span><span class="n">load_CV</span><span class="p">(</span><span class="s2">&quot;central_dihedrals&quot;</span><span class="p">)</span>
        <span class="n">_angles</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">_CVs</span><span class="o">.</span><span class="n">central_dihedrals</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">_angles</span><span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">_angles</span><span class="o">.</span><span class="n">CENTRAL_DIHEDRALS</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;psi&quot;</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">_angles</span><span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">_angles</span><span class="o">.</span><span class="n">CENTRAL_DIHEDRALS</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong type for arg `angles`.&quot;</span><span class="p">)</span>

    <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">psi</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;rad&quot;</span>
        <span class="n">tickrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;deg&quot;</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span>
    <span class="n">tickrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ticklabels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span><span class="p">[::</span><span class="n">subsample</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[::</span><span class="n">subsample</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">density_contour</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span>
        <span class="n">marginal_x</span><span class="o">=</span><span class="s2">&quot;violin&quot;</span><span class="p">,</span>
        <span class="n">marginal_y</span><span class="o">=</span><span class="s2">&quot;violin&quot;</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;psi&quot;</span><span class="p">},</span>
        <span class="n">range_x</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
        <span class="n">range_y</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;contours&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coloring</span> <span class="o">=</span> <span class="s2">&quot;fill&quot;</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Ramachandran plot&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">tickrange</span><span class="p">,</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="n">ticklabels</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">tickrange</span><span class="p">,</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="n">ticklabels</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_dssp">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_dssp">[docs]</a>
<span class="k">def</span> <span class="nf">plot_dssp</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">SingleTraj</span><span class="p">,</span>
    <span class="n">simplified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">subsample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">residue_subsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># get the dssp and color values</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>

    <span class="n">dssp</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">compute_dssp</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">simplified</span><span class="o">=</span><span class="n">simplified</span><span class="p">)</span>

    <span class="c1"># the yticks and yticklabels are created here</span>
    <span class="n">residues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">n_residues</span><span class="p">)</span>
    <span class="n">residue_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">residues</span><span class="p">])</span>

    <span class="c1"># subsample the dssp array</span>
    <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subsample</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">subsample</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subsample</span><span class="p">)</span>
        <span class="n">dssp</span> <span class="o">=</span> <span class="n">dssp</span><span class="p">[</span><span class="n">subsample</span><span class="p">]</span>

    <span class="c1"># vectorize the dssp-str -&gt; rgb-value function and apply</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">dssp_to_rgb</span><span class="p">,</span> <span class="n">simplified</span><span class="o">=</span><span class="n">simplified</span><span class="p">))</span>
    <span class="n">dssp_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">dssp</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">dssp_to_text</span><span class="p">,</span> <span class="n">simplified</span><span class="o">=</span><span class="n">simplified</span><span class="p">))</span>
    <span class="n">dssp_text</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">dssp</span><span class="p">)</span>

    <span class="c1"># create fig</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dssp_color</span><span class="p">)</span>
    <span class="n">customdata_res_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">residue_names</span><span class="p">,</span> <span class="p">(</span><span class="n">dssp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">customdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">customdata_res_names</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dssp_text</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;customdata&quot;</span><span class="p">:</span> <span class="n">customdata</span><span class="p">,</span>
                <span class="s2">&quot;hovertemplate&quot;</span><span class="p">:</span> <span class="s2">&quot;Time: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Residue: %</span><span class="si">{customdata[0]}</span><span class="s2">&lt;br&gt;DSSP: %</span><span class="si">{customdata[1]}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># subsample the residues for label purposes</span>
    <span class="k">if</span> <span class="n">residue_subsample</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">residues</span> <span class="o">=</span> <span class="n">residues</span><span class="p">[::</span><span class="n">residue_subsample</span><span class="p">]</span>
        <span class="n">residue_names</span> <span class="o">=</span> <span class="n">residue_names</span><span class="p">[::</span><span class="n">residue_subsample</span><span class="p">]</span>

    <span class="c1"># combine and update layout</span>
    <span class="c1"># fig = go.Figure(data=fig1.data + fig2.data)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;DSSP plot&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;residue&quot;</span><span class="p">,</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">residues</span><span class="p">,</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="n">residue_names</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;DSSP&quot;</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># add the legend</span>
    <span class="n">simplified_legend</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Coil&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(1.0, 1.0, 1.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Extended&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(1.0, 0.0, 0.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Helical&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.0, 0.0, 1.0)&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Coil&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(1.0, 1.0, 1.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Isolated beta-bridge&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.0, 0.0, 0.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Extended beta-ladder&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(1.0, 0.0, 0.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3/10-helix&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.5, 0.5, 0.5)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Alpha-helix&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.0, 0.0, 1.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pi-helix&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.0, 1.0, 1.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Bend&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(0.0, 1.0, 0.0)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hydrogen bonded Turn&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(1.0, 1.0, 0.0)&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">simplified_legend</span> <span class="k">if</span> <span class="n">simplified</span> <span class="k">else</span> <span class="n">legend</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iterator</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;legend1&quot;</span><span class="p">,</span>
            <span class="c1"># visible=&quot;legendonly&quot;,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">marker_color</span><span class="o">=</span><span class="n">val</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="c1"># show</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span> <span class="nf">dssp_to_text</span><span class="p">(</span>
    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">simplified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">simplified_dssp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;Coil&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;Extended&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="s2">&quot;Helical&quot;</span><span class="p">}</span>
    <span class="n">dssp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="s2">&quot;Coil&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;Isolated beta-bridge&quot;</span><span class="p">,</span>
        <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;Extended beta-ladder&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;3/10-helix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="s2">&quot;Alpha-helix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="s2">&quot;Pi-helix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Bend&quot;</span><span class="p">,</span>
        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;Hydrogen bonded Turn&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">simplified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simplified_dssp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dssp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">dssp_to_rgb</span><span class="p">(</span>
    <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">simplified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Here are the values returned for simplified:</span>

<span class="sd">        * &quot;C&quot;: coil, white, rgb(1, 1, 1)</span>
<span class="sd">        * &quot;E&quot;: extended, red, rgb(1, 0, 0)</span>
<span class="sd">        * &quot;H&quot;: helix, blue, rgb(0, 0, 1)</span>

<span class="sd">    And here for the full DSSP assignment:</span>

<span class="sd">        * &quot; &quot;: coil, white, rgb(1, 1, 1)</span>
<span class="sd">        * &quot;B&quot;: b-bridge, black, rgb(0, 0, 0)</span>
<span class="sd">        * &quot;E&quot;: b-sheet, red, rgb(1, 0, 0)</span>
<span class="sd">        * &quot;G&quot;: 3_10 helix, grey, rgb(0.5, 0.5, 0.5)</span>
<span class="sd">        * &quot;H&quot;: A-helix, blue, rgb(0, 0, 1)</span>
<span class="sd">        * &quot;I&quot;: pi-helix, purple, rgb(0, 1, 1)</span>
<span class="sd">        * &quot;S&quot;: bend, green, rgb(0, 1, 0)</span>
<span class="sd">        * &quot;T&quot;: turn, yellow(1, 1, 0)</span>

<span class="sd">    Args:</span>
<span class="sd">        val (str): The dssp value.</span>
<span class="sd">        simplified (bool): Whether to use the simplified scheme.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">simplified_dssp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}</span>
    <span class="n">dssp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">simplified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simplified_dssp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dssp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>


<div class="viewcode-block" id="plot_end2end">
<a class="viewcode-back" href="../../../api/encodermap.plot.html#encodermap.plot.plotting.plot_end2end">[docs]</a>
<span class="k">def</span> <span class="nf">plot_end2end</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">SingleTraj</span><span class="p">,</span>
    <span class="n">selstr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;name CA&quot;</span><span class="p">,</span>
    <span class="n">subsample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rolling_avg_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selstr</span><span class="p">)[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">compute_distances</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="p">[</span><span class="n">atoms</span><span class="p">])[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">time</span>
    <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subsample</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">subsample</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subsample</span><span class="p">)</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">subsample</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">subsample</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">dists</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time in ps&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;dist in nm&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">trendline</span><span class="o">=</span><span class="s2">&quot;rolling&quot;</span><span class="p">,</span>
        <span class="n">trendline_options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">window</span><span class="o">=</span><span class="n">rolling_avg_window</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;end to end distance&quot;</span><span class="p">,</span>
        <span class="n">marginal_y</span><span class="o">=</span><span class="s2">&quot;violin&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span> <span class="nf">_zoomingBoxManual</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">roiKwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">arrowKwargs</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fakes a zoom effect between two mpl.axes.Axes.</span>

<span class="sd">    Uses mpl.patches.ConnectionPatch and mpl.patches.Rectangle</span>
<span class="sd">    to make it seem like ax2 is a zoomed in version of ax1.</span>
<span class="sd">    Instead of defining the coordinates of the zooming rectangle</span>
<span class="sd">    The axes limits of ax2 are used.</span>

<span class="sd">    Args:</span>
<span class="sd">        ax1 (plt.axes): The axes with the zoomed-out data.</span>
<span class="sd">        ax2 (plt.axes): The second axes with the zoomed-in data.</span>
<span class="sd">        color (str): The color of the zoom effect. Is passed into mpl,</span>
<span class="sd">            thus can be str, or tuple, ... Defaults to &#39;red&#39;</span>
<span class="sd">        linewidth (int): The linewidth. Defaults to 2.</span>
<span class="sd">        roiKwargs (dict): Keyworded arguments for the rectangle.</span>
<span class="sd">            Defaults to {}.</span>
<span class="sd">        arrowKwargs (dict): Keyworded arguments for the arrow.</span>
<span class="sd">            Defaults to {}.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="o">*</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()])</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">limits</span>
    <span class="n">roiKwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;linestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;dashed&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="o">**</span><span class="n">roiKwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">[</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">roiKwargs</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">arrowKwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;arrowstyle&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">)]),</span>
        <span class="o">**</span><span class="n">arrowKwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">limits</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">limits</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">con1</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">ConnectionPatch</span><span class="p">(</span>
        <span class="n">xyA</span><span class="o">=</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">xyB</span><span class="o">=</span><span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">coordsA</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">coordsB</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">axesA</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
        <span class="n">axesB</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">con1</span><span class="o">.</span><span class="n">set_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">con1</span><span class="p">)</span>
    <span class="n">con1</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">con2</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">ConnectionPatch</span><span class="p">(</span>
        <span class="n">xyA</span><span class="o">=</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">xyB</span><span class="o">=</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">coordsA</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">coordsB</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">axesA</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
        <span class="n">axesB</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">con2</span><span class="o">.</span><span class="n">set_color</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">con2</span><span class="p">)</span>
    <span class="n">con2</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">render_vmd</span><span class="p">(</span>
    <span class="n">filepath</span><span class="p">,</span>
    <span class="n">rotation</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">script_location</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">image_location</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">image_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">drawframes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ssupdate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;tachyon&quot;</span><span class="p">,</span>
    <span class="n">additional_spheres</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">additional_lines</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">surf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Render pdb file with a combination of vmd, tachyon and image magick.</span>

<span class="sd">    This function creates a standardised vmd tcl/tk script and writes it</span>
<span class="sd">    to disk. Then vmd is called with the subprocess package and used to</span>
<span class="sd">    create a tachyon input file. Tachyon is then called to render the image</span>
<span class="sd">    with ambient occlusion and soft lighting. The output is a high quality</span>
<span class="sd">    targa (.tga) image, which is converted to png using image magick.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str): Location of the pdb file which should be rendered.</span>
<span class="sd">        rotation ([x_rot, y_rot, z_rot], optional): List of rotation values. Defaults to [0, 0, 0].</span>
<span class="sd">        scale (float, optional): By how much the structure should be scaled. Defaults to 1.</span>
<span class="sd">        script_location (str, optional): Where to save the script. Script will be removed</span>
<span class="sd">            after finish nonehteless. Defaults to &#39;auto&#39; and writes into cwd.</span>
<span class="sd">        image_location (str, optional): Where to render the images file to. Will be</span>
<span class="sd">            deleted nonetheless. Don&#39;t give an extension for this. Defaults to &#39;auto&#39; and</span>
<span class="sd">            writes into cwd.</span>
<span class="sd">        debug (bool, optional): Print debug info. Defaults to False.</span>
<span class="sd">        image_name (str, optional): This string will be used to save the image to after it has</span>
<span class="sd">            been rendered and converted to png. This will not be deleted. Defaults to &#39;&#39;.</span>
<span class="sd">        drawframes (bool, optional): If a trajectory is loaded, this will render all frames in it.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        ssupdate (bool, optional): Updates the secondary structure for every frame. Normally</span>
<span class="sd">            vmd uses the secondary structure of the first frame. Setting this to True calcs</span>
<span class="sd">            the sec struct for every frame. Defaults to True.</span>
<span class="sd">        renderer (str, optional): Which renderer to use.</span>
<span class="sd">            * &#39;tachyon&#39; uses the external Tachyon rendered. So vmd -&gt; .dat -&gt; .tga -&gt; .png.</span>
<span class="sd">            * &#39;snapshot&#39; uses the vmd internal snapshot renderer.</span>
<span class="sd">            Defaults to &#39;tachyon&#39;.</span>
<span class="sd">        additional_spheres (list, optional): Draw spheres around two subunits to make</span>
<span class="sd">            them visually more distinct. Takes a list of lists. Each list in the main</span>
<span class="sd">            list should contain 4 values [x, y, z, r] (r for radius). Defaults to [].</span>
<span class="sd">        additional_lines (list, optional): A list of additional lines that should be added to the</span>
<span class="sd">            script. Please refert to the vmd manual for further info. Defaults to [].</span>
<span class="sd">        surf (Union[str, None], optional): A string defining the surface renderer. Can either be</span>
<span class="sd">            &#39;quicksurf&#39; or &#39;surf&#39;. If None is provided, the surface won&#39;t be rendered (falls back</span>
<span class="sd">            to cartoon representation). Defaults to None.</span>
<span class="sd">        custom_script (Union[str, None], optional): Provide a completely custom script as this option.</span>
<span class="sd">            The render commands will still be appended to this script. If None is provided, the</span>
<span class="sd">            default script will be used.</span>

<span class="sd">    See also:</span>
<span class="sd">        See this nice webpage about rendering publication worthy images with vmd.</span>
<span class="sd">        https://www.ks.uiuc.edu/Research/vmd/minitutorials/tachyonao/</span>

<span class="sd">    Returns:</span>
<span class="sd">        image (np.ndarray): This array contains the raw pixel data.</span>
<span class="sd">            Can be used with matplotlib to have a quick view of the image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">image_location</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;The argument image_location does not take a file extension, because the name is used for a .dat, .tga and .png file.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># add a shebang to the script</span>
    <span class="c1"># script = &#39;#!/home/soft/bin/vmd\n\n&#39;</span>

    <span class="c1"># print debug hello world</span>
    <span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;puts &quot;Hello World&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># if a list of files is provided we iterate over them</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c1"># load molecule and change representation</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol new </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">surf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modstyle 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> newcartoon 0.3 50</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modcolor 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> structure</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">surf</span> <span class="o">==</span> <span class="s2">&quot;quicksurf&quot;</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modstyle 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> quicksurf 0.6 0.7 0.7 Medium</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modstyle 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modmaterial 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> AOChalky</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">drawframes</span> <span class="ow">and</span> <span class="n">md</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;STL&quot;</span><span class="p">:</span>
                    <span class="c1"># Standard Library Imports</span>
                    <span class="kn">import</span> <span class="nn">warnings</span>

                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Rendering multiple frames with STL may lead to &quot;</span>
                        <span class="s2">&quot;undesired results. Instead of yielding the union of &quot;</span>
                        <span class="s2">&quot;all single-frame surfaces, you will get a mishmash of &quot;</span>
                        <span class="s2">&quot;all surfaces with intersection faces etc.&quot;</span>
                    <span class="p">)</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol drawframes 0 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> 0:1:999</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># load molecule and change representation</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol new </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">surf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol modstyle 0 0 newcartoon 0.3 50</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol modcolor 0 0 structure</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">surf</span> <span class="o">==</span> <span class="s2">&quot;quicksurf&quot;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol modstyle 0 0 quicksurf 0.6 0.7 0.7 Medium</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;mol modstyle 0 0 </span><span class="si">{</span><span class="n">surf</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol modmaterial 0 0 AOChalky</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">drawframes</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol drawframes 0 0 0:1:999</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">ssupdate</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[93m&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;For the ssupdate function to work encodermap/vmd/sscache.tcl will be sourced within vmd. If no Error is thrown the file is present.&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
        <span class="p">)</span>
        <span class="n">sscache_location</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;/vmd/sscache.tcl&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sscache_location</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The sscache.tcl script is not here: </span><span class="si">{</span><span class="n">sscache_location</span><span class="si">}</span><span class="s2">. Please put it there.&quot;</span>
            <span class="p">)</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;source </span><span class="si">{</span><span class="n">sscache_location</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;start_sscache 0</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1">#         script += &quot;proc update_secondary_structure_assigment { args } {&quot;</span>
    <span class="c1">#         script += &quot;  foreach molid [molinfo list] {&quot;</span>
    <span class="c1">#         script += &quot;    mol ssrecalc $molid&quot;</span>
    <span class="c1">#         script += &quot;  }&quot;</span>
    <span class="c1">#         script += &quot;}&quot;</span>
    <span class="c1">#         script += &quot;trace variable vmd_frame(0) w update_secondary_structure_assigment&quot;</span>

    <span class="c1"># change some parameters to make a nice image</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;color Display Background white</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;color Axes Labels black</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;display depthcue off</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;display ambientocclusion on</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;display aoambient 1.0</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;display aodirect 0.3</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;display antialias on</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># script += &#39;display resize 2000 2000\n&#39;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;axes location off</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># scale and rotate</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;rotate x by </span><span class="si">{</span><span class="n">rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;rotate y by </span><span class="si">{</span><span class="n">rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;rotate z by </span><span class="si">{</span><span class="n">rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;scale by </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># define image location</span>
    <span class="k">if</span> <span class="n">image_location</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">image_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/vmdscene&quot;</span>

    <span class="c1"># add spheres</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">additional_spheres</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">additional_spheres</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;iceblue&quot;</span><span class="p">]):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;draw color </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;draw sphere </span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2"> radius </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> resolution 25</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;draw material Transparent</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># add additional lines</span>
    <span class="k">if</span> <span class="n">additional_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">additional_lines</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">custom_script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">custom_script</span>

    <span class="c1"># render command. Alternatively, I can use external Tachyon, which makes better images</span>
    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;tachyon&quot;</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;render Tachyon </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.dat</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;render aasamples TachyonInternal 6</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;render TachyonInternal </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;STL&quot;</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;axes location off</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;render STL </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.stl</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;Wavefront&quot;</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;axes location off</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;render Wavefront </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.obj</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Other renderers than tachyon and snaphsot currently not supported.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># list molecules and quit</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;mol list</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;quit&quot;</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="c1"># write the script</span>
    <span class="k">if</span> <span class="n">script_location</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">script_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/vmd_script.tcl&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_location</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="c1"># call vmd -e script</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;vmd -e </span><span class="si">{</span><span class="n">script_location</span><span class="si">}</span><span class="s2"> -dispdev none&quot;</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="c1"># check if image has been written</span>
    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;tachyon&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.dat&quot;</span>
        <span class="p">),</span> <span class="s2">&quot;Tachyon datafile not generated by renderer&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga&quot;</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Snapshot image not created. </span><span class="si">{</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga&quot;</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Tachyon datafile not generated by renderer. Here&#39;s the script:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">script</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;tachyon&quot;</span><span class="p">:</span>
        <span class="c1"># call Tachyon and render</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/usr/bin/tachyon -aasamples 12 </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.dat -res 2000 2000 -fullshade -format TARGA -o </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga&quot;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="c1"># check if image has been written</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga&quot;</span>
        <span class="p">),</span> <span class="s2">&quot;Tachyon renderer did not render image&quot;</span>

    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;STL&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image_name</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.stl&quot;</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span>
        <span class="c1"># Third Party Imports</span>
        <span class="kn">import</span> <span class="nn">trimesh</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.stl&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.stl&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mesh</span>

    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;Wavefront&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image_name</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.obj&quot;</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.mtl&quot;</span><span class="p">,</span> <span class="n">image_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.obj&quot;</span><span class="p">,</span> <span class="s2">&quot;.mtl&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Find the rendered images at </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">image_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.obj&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.mtl&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># convert to png</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/usr/bin/convert </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga </span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="c1"># read image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>

    <span class="c1"># write image if name has been provided</span>
    <span class="k">if</span> <span class="n">image_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">image_name</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># remove temporary files</span>
    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s2">&quot;tachyon&quot;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.tga&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_location</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="c1"># os.remove(f&#39;{script_location}&#39;)</span>

    <span class="c1"># return matplotlib image object</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">plot_cluster</span><span class="p">(</span>
    <span class="n">trajs</span><span class="p">,</span> <span class="n">pdb_path</span><span class="p">,</span> <span class="n">png_path</span><span class="p">,</span> <span class="n">cluster_no</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;_user_selected_points&quot;</span>
<span class="p">):</span>
    <span class="c1"># Third Party Imports</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cluster_no</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cluster_no</span> <span class="o">=</span> <span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># prepare ax1 to make the two side histograms</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax4</span><span class="p">)</span>
    <span class="n">axHistx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># , sharex=ax1)</span>
    <span class="n">axHisty</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># , sharey=ax1)</span>

    <span class="c1"># some data management</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">trajs</span><span class="o">.</span><span class="n">lowd</span>
    <span class="n">where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_no</span><span class="p">)</span>
    <span class="n">not_where</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">trajs</span><span class="o">.</span><span class="n">CVs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cluster_no</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># scatter everything grey and cluster blue</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">not_where</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x in a.u.&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y in a.u.&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scatter of low-dimensional data&quot;</span><span class="p">)</span>

    <span class="c1"># density</span>
    <span class="n">bin_density</span> <span class="o">=</span> <span class="mi">46</span>
    <span class="n">log_density</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># ax2 gets hexbin density</span>
    <span class="c1"># x_bins = np.linspace(x.min(), x.max(), bin_density)</span>
    <span class="c1"># y_bins = np.linspace(y.min(), y.max(), bin_density)</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_density</span><span class="p">)</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">xcenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ycenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xcenters</span><span class="p">,</span> <span class="n">ycenters</span><span class="p">)</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">log_density</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>  <span class="c1"># ignore division by zero error</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">H</span>
    <span class="c1"># mappable = ax2.hexbin(x=X.ravel(), y=Y.ravel(), C=F.T.ravel(), cmap=plt.cm.turbo_r, extent=extent,</span>
    <span class="c1">#                       norm=mpl.colors.PowerNorm(1), gridsize=bin_density +1)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;turbo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_extremes</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">20</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x in a.u.&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y in a.u.&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Log density of points&quot;</span><span class="p">)</span>

    <span class="c1"># colorbar for ax2</span>
    <span class="c1"># colorbar</span>
    <span class="c1"># use the axes divider method to add colorbar</span>
    <span class="n">ax_divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>
    <span class="c1"># add colorbaraxis to work with ticks and whatnot</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">ax_divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;7%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">)</span>
    <span class="c1"># define colorbar norm. I like to work with values between 0 and 1</span>
    <span class="c1"># initialize colormap</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of points&quot;</span><span class="p">)</span>

    <span class="c1"># cluster on ax4</span>
    <span class="c1"># x hist</span>
    <span class="n">spines</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">axHistx</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">axHistx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="n">where</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">axHistx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Scatter of Cluster&quot;</span><span class="p">)</span>

    <span class="c1"># y hist</span>
    <span class="n">spines</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">axHisty</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">axHisty</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][</span><span class="n">where</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span>
    <span class="p">)</span>
    <span class="n">axHisty</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>

    <span class="c1"># scatter data</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">spines</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ax4</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x in a.u.&quot;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y in a.u.&quot;</span><span class="p">)</span>

    <span class="c1"># annotate rms</span>
    <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">]))</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RMS = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rms</span><span class="p">,</span><span class="w"> </span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

    <span class="c1"># annotate geometric center</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">where</span><span class="p">])]</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">centroid</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;geom. center&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="n">centroid</span><span class="p">,</span>
        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># annotate rmsd center</span>
    <span class="c1"># view, dummy_traj = gen_dummy_traj(trajs, cluster_no, max_frames=100, col=col)</span>
    <span class="c1"># index, distances, centroid = rmsd_centroid_of_cluster(dummy_traj, parallel=False)</span>
    <span class="c1"># idx = np.round(np.linspace(0, len(where) - 1, 100)).astype(int)</span>
    <span class="c1"># where = where[idx]</span>
    <span class="c1"># centroid = data[where[0][::5][index]]</span>
    <span class="c1"># ax4.scatter(*centroid, s=50, c=&#39;C2&#39;)</span>
    <span class="c1"># ax4.annotate(&#39;rmsd center&#39;,</span>
    <span class="c1">#             xy=centroid, xycoords=&#39;data&#39;,</span>
    <span class="c1">#             xytext=(0.95, 0.85), textcoords=&#39;axes fraction&#39;,</span>
    <span class="c1">#             arrowprops=dict(facecolor=&#39;black&#39;, shrink=0.05, fc=&quot;w&quot;, ec=&quot;k&quot;, lw=2),</span>
    <span class="c1">#             horizontalalignment=&#39;right&#39;, verticalalignment=&#39;top&#39;, color=&#39;C2&#39;)</span>

    <span class="c1"># make vmd snapshot</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">render_vmd</span><span class="p">(</span>
            <span class="n">pdb_path</span><span class="p">,</span> <span class="n">drawframes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;tachyon&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span>
        <span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ax3</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Image of cluster&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;VMD Rendering not possible&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">pass</span>

    <span class="c1"># # calculate distances between rmsd centroid and all other points</span>
    <span class="c1"># distances = scipy.spatial.distance.cdist(centroid.reshape(1, 2), np.stack([x, y]).T)</span>
    <span class="c1"># H, edges, patches = ax3.hist(distances.flatten(), color=&#39;C1&#39;)</span>
    <span class="c1"># ax3.set_title(&quot;Distances to rmsd centroid.&quot;)</span>
    <span class="c1"># ax3.set_xlabel(&quot;Distance in a.u.&quot;)</span>
    <span class="c1"># ax3.set_ylabel(&quot;Count&quot;)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_no</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Kevin Sawade, Tobias Lemke, University of Konstanz.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on 2025-05-15T21:24:25.
  <br/>
</p></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">Docs for EncoderMap 3.0.1+10.g67ae638.dirty</div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>